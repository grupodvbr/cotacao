<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Comparador de Pre√ßos ‚Ä¢ Grupo DV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f9fafb;
  margin: 0; padding: 20px;
}
h1 {
  text-align: center;
  color: #222;
}
#busca {
  width: 100%;
  max-width: 450px;
  display: block;
  margin: 10px auto 20px;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 15px;
}
#btnVoltar {
  display: none;
  margin: 0 auto 20px;
  background: #222;
  color: #fff;
  border: none;
  padding: 8px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
#btnVoltar:hover { background: #444; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
  font-size: 14px;
}
th { background: #222; color: #fff; }
tr:nth-child(even) { background: #f1f1f1; }
tr:hover { background: #e9e9e9; cursor: pointer; }
tr.menor { background: #c6f6d5; font-weight: 600; }
.loader { text-align: center; margin-top: 50px; }
thead tr th { position: sticky; top: 0; z-index: 10; }
</style>
</head>
<body>

<h1>üí∞ Comparador de Pre√ßos e Busca Global</h1>
<input id="busca" type="text" placeholder="üîç Buscar produto na planilha de itens..." onkeyup="buscarGlobal()">
<button id="btnVoltar" onclick="voltarComparativo()">‚¨Ö Voltar ao Comparativo</button>
<div id="tabela"></div>

<script>
// URL do Apps Script
const BASE_URL = "https://script.google.com/macros/s/AKfycbyw20TIKL9TpSdxZweHj2itsKbGXFyQdUADp1zzNBV4G6TTgVktUMfGMdVIUWEeHQqVcA/exec";

// ================ COMPARATIVO PADR√ÉO ================
async function carregarComparativo() {
  const div = document.getElementById('tabela');
  const btn = document.getElementById('btnVoltar');
  btn.style.display = "none";
  div.innerHTML = '<div class="loader">‚è≥ Carregando comparativo...</div>';

  try {
    const res = await fetch(`${BASE_URL}?action=comparar`);
    const data = await res.json();
    renderComparativo(data);
  } catch (err) {
    div.innerHTML = `<p>Erro ao carregar: ${err.message}</p>`;
  }
}

// ================ RENDERIZA COMPARATIVO ================
function renderComparativo(data) {
  const div = document.getElementById('tabela');
  if (!data || data.length === 0) {
    div.innerHTML = '<p>Nenhum dado dispon√≠vel.</p>';
    return;
  }

  let html = `<table id="tabelaPrincipal">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Unidade</th>
        <th>Quantidade</th>
        <th>Loja</th>
        <th>Fornecedor Mais Barato</th>
        <th>Valor Unit√°rio</th>
      </tr>
    </thead><tbody>`;

  data.forEach((item, i) => {
    html += `<tr class="${item.fornecedor_mais_barato !== 'N/D' ? 'menor' : ''}" onclick="abrirModal(${i})">
      <td>${item.produto}</td>
      <td>${item.unidade || '-'}</td>
      <td>${item.quantidade || 0}</td>
      <td>${item.loja || '-'}</td>
      <td>${item.fornecedor_mais_barato}</td>
      <td>R$ ${(item.valor_unitario || 0).toFixed(2)}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  div.innerHTML = html;
  window.todosDados = data;
}

// ================ BUSCA GLOBAL ================
async function buscarGlobal() {
  const termo = document.getElementById('busca').value.trim().toLowerCase();
  const div = document.getElementById('tabela');
  const btn = document.getElementById('btnVoltar');

  if (termo.length < 2) {
    carregarComparativo();
    return;
  }

  div.innerHTML = '<div class="loader">üîé Buscando produtos na planilha...</div>';
  btn.style.display = "inline-block";

  try {
    const res = await fetch(`${BASE_URL}?buscar=${encodeURIComponent(termo)}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      div.innerHTML = `<p>Nenhum produto encontrado contendo "<strong>${termo}</strong>".</p>`;
      return;
    }

    let html = `<table><thead><tr>
      <th>Loja</th>
      <th>Fornecedor</th>
      <th>Descri√ß√£o</th>
      <th>Valor Unit√°rio</th>
    </tr></thead><tbody>`;

    data.forEach(i => {
      html += `<tr>
        <td>${i.loja}</td>
        <td>${i.fornecedor}</td>
        <td>${i.descricao}</td>
        <td>R$ ${(i.valor_unitario || 0).toFixed(2)}</td>
      </tr>`;
    });

    html += '</tbody></table>';
    div.innerHTML = html;
  } catch (err) {
    div.innerHTML = `<p>Erro: ${err.message}</p>`;
  }
}

// ================ VOLTAR AO COMPARATIVO ================
function voltarComparativo() {
  document.getElementById('busca').value = '';
  carregarComparativo();
}

// ================ MODAL DETALHADO ================
function abrirModal(index) {
  const item = window.todosDados[index];
  if (!item || !item.fornecedores) return;

  let modalHTML = `<div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>${item.produto.toUpperCase()}</h2>
        <button class="close-btn" onclick="fecharModal()">Fechar</button>
      </div>
      <div id="modalConteudo">`;

  if (item.fornecedores.length === 0) {
    modalHTML += `<p>Nenhum fornecedor encontrado para esse item.</p>`;
  } else {
    modalHTML += `<table style="width:100%; border-collapse:collapse;">
      <thead><tr style="background:#222; color:#fff;">
        <th>Loja</th><th>Fornecedor</th><th>Descri√ß√£o</th><th>Valor Unit√°rio</th><th>Valor Total</th>
      </tr></thead><tbody>`;

    item.fornecedores.sort((a, b) => a.valorUnit - b.valorUnit);
    item.fornecedores.forEach(f => {
      const destaque = f.fornecedor === item.fornecedor_mais_barato;
      modalHTML += `<tr style="background:${destaque ? '#c6f6d5' : 'transparent'};font-weight:${destaque ? '600' : '400'};">
        <td>${f.loja}</td>
        <td>${f.fornecedor}</td>
        <td>${f.descricaoItem}</td>
        <td>R$ ${(f.valorUnit || 0).toFixed(2)}</td>
        <td>R$ ${(f.valorTotal || 0).toFixed(2)}</td>
      </tr>`;
    });

    modalHTML += '</tbody></table>';
  }

  modalHTML += '</div></div></div>';
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  document.getElementById('modal').style.display = 'flex';
}
function fecharModal() {
  const modal = document.getElementById('modal');
  if (modal) modal.remove();
}

// Inicializa
carregarComparativo();
</script>
</body>
</html>
