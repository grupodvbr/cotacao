<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Licita√ß√µes</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ================================
   PALETA CORPORATIVA PREMIUM
================================ */
:root {
  --azul: #0b1e39;
  --azul-light: #193055;
  --dourado: #c9a86c;
  --soft: #f2f4f7;
  --card: #ffffff;
  --shadow: 0 10px 30px rgba(0,0,0,0.15);
}

/* ================================
   BASE
================================ */
* {
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter', sans-serif;
}

body {
  background: var(--soft);
  padding:30px;
}

/* ================================
   TOPO / FILTROS / PESQUISA
================================ */
#topo {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:25px;
}

#titulo {
  font-size:32px;
  font-weight:700;
  color:var(--azul);
}

#searchBar {
  padding:12px 15px;
  width:280px;
  border-radius:10px;
  border:1px solid #d0d0d0;
  background:white;
  font-size:15px;
}

#filtros {
  display:flex;
  gap:10px;
  margin-top:15px;
}

.filtro {
  padding:8px 18px;
  background:white;
  border:1px solid #ccc;
  border-radius:20px;
  cursor:pointer;
  transition:.2s;
}
.filtro:hover,
.filtro.ativo {
  background:var(--azul);
  color:white;
  border-color:var(--azul);
}

/* ================================
   BOT√ÉO NOVA LICITA√á√ÉO
================================ */
#btnNova {
  padding:11px 20px;
  background:var(--azul);
  color:white;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
#btnNova:hover { background:var(--azul-light); }

/* ================================
   GRID DE CARDS
================================ */
#cards {
  margin-top:25px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:25px;
}

.card {
  background:white;
  border-radius:14px;
  padding:22px;
  box-shadow:var(--shadow);
  position:relative;
  cursor:pointer;
  transition:.2s;
}
.card:hover { transform:translateY(-6px); }

.card h3 {
  font-size:20px;
  color:#000;
  margin-bottom:6px;
}

.card small { color:#555; }

.status {
  margin-top:12px;
  padding:6px 12px;
  border-radius:8px;
  display:inline-block;
  font-size:14px;
  font-weight:600;
}

/* cores de status */
.st-Pendente { background:#fde2b3; color:#b56a00; }
.st-Futura { background:#d7e7ff; color:#2655a4; }
.st-Em.andamento { background:#fff2a6; color:#9c7a00; }
.st-Finalizada { background:#c9f5c3; color:#1d7a2f; }
.st-Suspensa { background:#ffcdcd; color:#a21414; }

/* menu ... */
.menu-btn {
  position:absolute;
  top:10px;
  right:10px;
  font-size:22px;
  cursor:pointer;
  padding:4px;
}
.menu-box {
  position:absolute;
  top:35px;
  right:10px;
  background:white;
  border-radius:8px;
  border:1px solid #ccc;
  box-shadow:0 5px 20px rgba(0,0,0,0.15);
  display:none;
  z-index:99;
}
.menu-box div {
  padding:10px 14px;
  cursor:pointer;
  border-bottom:1px solid #eee;
}
.menu-box div:hover {
  background:#f3f3f3;
}
.menu-box div:last-child { border-bottom:none; }

/* ================================
   MODAL PADR√ÉO
================================ */
#modal, #modalItens {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.45);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-box {
  background:white;
  width:95%;
  max-width:600px;
  padding:25px;
  border-radius:14px;
  max-height:90vh;
  overflow:auto;
}

.modal-box h2 { margin-bottom:20px; color:var(--azul); }

.input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:12px;
}

/* bot√µes */
.btn {
  padding:12px 18px;
  border-radius:10px;
  background:var(--azul);
  border:none;
  color:white;
  font-weight:600;
  cursor:pointer;
}
.btn:hover { background:var(--azul-light); }

.btn-secondary {
  margin-left:10px;
  background:#ccc;
  color:#000;
}
.btn-secondary:hover { background:#b2b2b2; }

/* tabela de itens */
.item-row {
  background:white;
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

/* bot√£o upload */
#uploadInput { display:none; }

</style>
</head>

<body>

<div id="topo">
  <div>
    <h1 id="titulo">Licita√ß√µes</h1>

    <div id="filtros">
      <div class="filtro ativo" data-filter="todos">Todos</div>
      <div class="filtro" data-filter="Pendente">Pendente</div>
      <div class="filtro" data-filter="Futura">Futura</div>
      <div class="filtro" data-filter="Em andamento">Em andamento</div>
      <div class="filtro" data-filter="Finalizada">Finalizada</div>
      <div class="filtro" data-filter="Suspensa">Suspensa</div>
    </div>
  </div>

  <div>
    <input id="searchBar" placeholder="Pesquisar..." />
    <button id="btnNova" onclick="openModal()">+ Nova Licita√ß√£o</button>
  </div>
</div>

<div id="cards">Carregando...</div>

<!-- =======================
     MODAL LICITA√á√ÉO
======================= -->
<div id="modal">
  <div class="modal-box">
    <h2 id="modalTitulo">Nova Licita√ß√£o</h2>

    <input id="inst" class="input" placeholder="Institui√ß√£o">
    <input id="valor" class="input" placeholder="Valor Total">
    <input id="dataSessao" class="input" placeholder="Data da Sess√£o">
    <input id="criterio" class="input" placeholder="Crit√©rio de Julgamento">
    <input id="modo" class="input" placeholder="Modo de Disputa">

    <select id="status" class="input">
      <option value="Pendente">Pendente</option>
      <option value="Futura">Futura</option>
      <option value="Em andamento">Em andamento</option>
      <option value="Finalizada">Finalizada</option>
      <option value="Suspensa">Suspensa</option>
    </select>

    <button class="btn" onclick="saveLicitacao()">Salvar</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
  </div>
</div>

<!-- =======================
     MODAL ITENS
======================= -->
<div id="modalItens">
  <div class="modal-box">
    <h2>Itens da Licita√ß√£o</h2>

    <div id="listaItens"></div>

    <h3 style="margin-top:20px;">Adicionar Item</h3>

    <input id="i_itemTR" class="input" placeholder="Item TR">
    <input id="i_espec" class="input" placeholder="Especifica√ß√£o">
    <input id="i_marca" class="input" placeholder="Marca">
    <input id="i_modelo" class="input" placeholder="Modelo">
    <input id="i_unidade" class="input" placeholder="Unidade">
    <input id="i_qmax" class="input" placeholder="Quantidade M√°xima">
    <input id="i_qmin" class="input" placeholder="Quantidade M√≠nima">
    <input id="i_valor" class="input" placeholder="Valor Unit√°rio">
    <input id="i_garantia" class="input" placeholder="Garantia">

    <button class="btn" onclick="addItem()">Adicionar Item</button>

    <h3 style="margin-top:25px;">Importar Planilha</h3>

    <input type="file" id="uploadInput" onchange="uploadSheet(event)">
    <button class="btn" onclick="document.getElementById('uploadInput').click()">Upload XLS / CSV</button>

    <br><br>
    <button class="btn btn-secondary" onclick="closeItens()">Fechar</button>

  </div>
</div>

<script>
/* ================================
   CONFIG
================================ */
const API = "https://script.google.com/macros/s/AKfycbw8uAkvcy-7bRLFwamJk3ohldgtReshd7ZXUncE2RY_tlZWnTbxGEM3LLJ2A_txxtsJ/exec";

let EDITANDO = null;
let instAtual = null;

/* ================================
   CARREGAR LISTA
================================ */
async function carregar(){
  const req = await fetch(API+"?action=listar");
  const data = await req.json();
  renderCards(data);
}

/* ================================
   RENDERIZAR CARDS
================================ */
function renderCards(lista){
  const q = searchBar.value.trim().toLowerCase();
  const filtro = document.querySelector(".filtro.ativo").dataset.filter;

  let filtrados = lista.filter(l =>
    (filtro==="todos" || l.status===filtro) &&
    (l.instituicao.toLowerCase().includes(q))
  );

  cards.innerHTML = filtrados.map(l => `
    <div class="card">
      <div class="menu-btn" onclick="toggleMenu(event,'${l.instCode}')">‚Ä¢‚Ä¢‚Ä¢</div>

      <div class="menu-box" id="menu-${l.instCode}">
        <div onclick="openEdit('${l.instCode}','${l.instituicao}','${l.valor}','${l.dataSessao}','${l.criterio}','${l.modo}','${l.status}')">‚úèÔ∏è Editar</div>
        <div onclick="delLicitacao('${l.instCode}')">üóëÔ∏è Excluir</div>
        <div onclick="exportarExcel('${l.instCode}')">‚¨á Excel</div>
        <div onclick="gerarPDF('${l.instCode}')">üìÑ PDF</div>
      </div>

      <div onclick="openItens('${l.instCode}')">
        <h3>${l.instituicao}</h3>
        <small><b>C√≥digo:</b> ${l.instCode}</small><br>
        <small><b>Valor:</b> R$ ${l.valor}</small><br>
        <small><b>Data:</b> ${l.dataSessao}</small><br>

        <div class="status st-${l.status.replace(' ','.')}">${l.status}</div>
      </div>
    </div>
  `).join("") || "Nenhuma licita√ß√£o encontrada.";
}

/* ================================
   MENU ‚Ä¢‚Ä¢‚Ä¢
================================ */
function toggleMenu(ev,id){
  ev.stopPropagation();
  const box = document.getElementById("menu-"+id);
  box.style.display = box.style.display==="block" ? "none" : "block";
}

document.body.onclick = ()=> {
  document.querySelectorAll(".menu-box").forEach(m=>m.style.display="none");
};

/* ================================
   MODAL LICITA√á√ÉO
================================ */
function openModal(){
  EDITANDO = null;
  modalTitulo.innerText = "Nova Licita√ß√£o";
  inst.value=""; valor.value=""; dataSessao.value="";
  criterio.value=""; modo.value=""; status.value="Pendente";
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

/* ================================
   SALVAR LICITA√á√ÉO
================================ */
async function saveLicitacao(){
  const data = {
    instituicao:inst.value,
    valor:valor.value,
    dataSessao:dataSessao.value,
    criterio:criterio.value,
    modo:modo.value,
    status:status.value
  };

  let action = "addLicitacao";

  if(EDITANDO){
    data.instCode = EDITANDO;
    action = "editLicitacao";
  }

  data.action = action;

  await fetch(API,{
    method:"POST",
    body:JSON.stringify(data)
  });

  closeModal();
  carregar();
}

/* EDITAR */
function openEdit(id,insti,val,dt,crit,mod,stat){
  EDITANDO = id;
  modalTitulo.innerText = "Editar Licita√ß√£o";

  inst.value = insti;
  valor.value = val;
  dataSessao.value = dt;
  criterio.value = crit;
  modo.value = mod;
  status.value = stat;

  modal.style.display="flex";
}

/* EXCLUIR */
async function delLicitacao(id){
  if(!confirm("Excluir definitivamente?")) return;
  await fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"delLicitacao",instCode:id})
  });
  carregar();
}

/* ================================
   MODAL ITENS
================================ */
async function openItens(code){
  instAtual = code;
  modalItens.style.display="flex";

  const req = await fetch(API+"?action=itens&code="+code);
  const dados = await req.json();

  listaItens.innerHTML = dados.map(i => `
    <div class="item-row">
      <b>${i.itemTR}</b> ‚Äî ${i.especificacao} <br>
      <small>${i.marca} | ${i.modelo} | ${i.unidade}</small>
    </div>
  `).join("") || "Nenhum item cadastrado.";
}

function closeItens(){ modalItens.style.display="none"; }

/* ADD ITEM MANUAL */
async function addItem(){
  const data = {
    action:"addItem",
    instCode:instAtual,
    itemTR:i_itemTR.value,
    especificacao:i_espec.value,
    marca:i_marca.value,
    modelo:i_modelo.value,
    unidade:i_unidade.value,
    quantMax:i_qmax.value,
    quantMin:i_qmin.value,
    valorUnit:i_valor.value,
    garantia:i_garantia.value
  };

  await fetch(API,{
    method:"POST",
    body:JSON.stringify(data)
  });

  openItens(instAtual);
}

/* ================================
   IMPORTA√á√ÉO DE PLANILHA
================================ */
async function uploadSheet(ev){
  const file = ev.target.files[0];
  const reader = new FileReader();

  reader.onload = async function(){
    let linhas = [];
    const rows = reader.result.split(/\r?\n/);

    for(let r of rows){
      const cols = r.split(",");
      if(cols.length<5) continue;

      linhas.push({
        itemTR:cols[0],
        especificacao:cols[1],
        marca:cols[2],
        modelo:cols[3],
        unidade:cols[4],
        quantMax:cols[5],
        quantMin:cols[6],
        valorUnit:cols[7],
        garantia:cols[8]
      });
    }

    await fetch(API,{
      method:"POST",
      body:JSON.stringify({
        action:"importarItens",
        instCode:instAtual,
        itens:linhas
      })
    });

    alert("Itens importados!");
    openItens(instAtual);
  };

  reader.readAsText(file);
}

/* ================================
   EXPORTAR EXCEL
================================ */
async function exportarExcel(id){
  const req = await fetch(API+"?action=exportar&code="+id);
  const js = await req.json();
  window.open(js.url,"_blank");
}

/* ================================
   GERAR PDF
================================ */
async function gerarPDF(id){
  const req = await fetch(API+"?action=pdf&code="+id);
  const js = await req.json();

  const link = document.createElement("a");
  link.href = "data:application/pdf;base64,"+js.pdf;
  link.download = "Licitacao_"+id+".pdf";
  link.click();
}

/* ================================
   FILTRO E BUSCA
================================ */
searchBar.onkeyup = carregar;

document.querySelectorAll(".filtro").forEach(f=>{
  f.onclick = ()=>{
    document.querySelectorAll(".filtro").forEach(x=>x.classList.remove("ativo"));
    f.classList.add("ativo");
    carregar();
  };
});

/* ================================
   INICIAR
================================ */
carregar();

</script>
</body>
</html>
