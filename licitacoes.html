<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LICITAR • Painel de Licitações</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f4f6fa; --azul:#0b1e39; --azul2:#193055; --dourado:#c9a86c;
  --card:#fff; --muted:#64748b; --ok:#16a34a; --danger:#dc2626; --warn:#b45309;
  --shadow:0 10px 28px rgba(0,0,0,.10); --radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif}
body{background:var(--bg);color:#0f172a;padding:28px}

/* Topo */
.topo{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.titulo{color:var(--azul);font-size:28px;font-weight:700;letter-spacing:.5px}
.actions{display:flex;gap:10px;align-items:center}
.input{padding:12px;border:1px solid #d0d4da;border-radius:12px;background:#fff;width:280px;font-size:14px}
.btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--azul);color:#fff}.btn-primary:hover{background:var(--azul2)}
.btn-lite{background:#fff;border:1px solid #d0d4da}
.btn-danger{background:var(--danger);color:#fff}
.btn-ok{background:var(--ok);color:#fff}
.btn-ghost{background:transparent;color:var(--azul);border:1px dashed var(--azul)}

/* Filtros */
.filtros{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
.chip{padding:8px 14px;border-radius:999px;border:1px solid #c7ccd4;background:#fff;cursor:pointer;font-weight:600}
.chip.ativo{background:var(--azul);color:#fff;border-color:var(--azul)}

/* Lista */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;border-left:6px solid var(--azul)}
.card h3{font-size:18px;margin-bottom:6px}
.card small{color:#475569}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.kv{font-size:13px;color:#0f172a;background:#f8fafc;border:1px solid #e6e9ee;border-radius:10px;padding:6px 10px}
.status{display:inline-block;margin-top:10px;padding:6px 10px;border-radius:10px;font-weight:700;font-size:12px}
.st-Pendente{background:#fff3cd;color:#a15e00}.st-Futura{background:#dbeafe;color:#1e40af}
.st-Em\ andamento{background:#fef9c3;color:#854d0e}.st-Finalizada{background:#dcfce7;color:#166534}
.st-Suspensa{background:#ffe4e6;color:#9f1239}
.card-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.card-actions .btn{padding:9px 12px;border-radius:10px;font-size:12px}

/* Overlay */
#overlay{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:9999}
#overlay .box{background:#fff;padding:22px 26px;border-radius:12px;box-shadow:var(--shadow);font-weight:700;color:var(--azul)}

/* Toast */
.toast{position:fixed;right:16px;bottom:16px;z-index:99999;background:#fff;border-left:6px solid var(--danger);padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);min-width:300px;max-width:520px;white-space:pre-wrap}
.toast.ok{border-left-color:var(--ok)}
.toast.warn{border-left-color:var(--warn)}
.toast b{display:block;margin-bottom:4px}
.toast small{display:block;color:#64748b}

/* Modais */
.modal{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:9998;padding:16px}
.modal .content{background:#fff;border-radius:16px;box-shadow:var(--shadow);max-width:980px;width:100%;padding:20px}
.modal .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.grid-modal{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
.field{margin-bottom:10px}
label{font-size:12px;color:#334155;font-weight:700;letter-spacing:.3px}
.field input,.field select{width:100%;padding:12px;border:1px solid #d0d4da;border-radius:12px;background:#fff;font-size:14px;text-transform:uppercase}
.help{font-size:11px;color:#64748b;margin-top:4px}
.close{background:#e2e8f0;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}

/* Tabela */
.table-wrap{max-height:320px;overflow:auto;border:1px solid #e2e8f0;border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left}
th{background:#f8fafc;position:sticky;top:0}
</style>
</head>

<body>

<!-- Overlay -->
<div id="overlay"><div class="box">ENVIANDO…</div></div>

<!-- Topo -->
<div class="topo">
  <div class="titulo">LICITAR • Painel de Licitações</div>
  <div class="actions">
    <input id="busca" class="input" placeholder="BUSCAR LICITAÇÃO" />
    <button class="btn btn-primary" onclick="abrirModalLicitacao()">+ Nova Licitação</button>
  </div>
</div>

<!-- Filtros -->
<div class="filtros" id="filtros">
  <div class="chip ativo" data-status="TODOS">Todos</div>
  <div class="chip" data-status="PENDENTE">Pendente</div>
  <div class="chip" data-status="FUTURA">Futura</div>
  <div class="chip" data-status="EM ANDAMENTO">Em andamento</div>
  <div class="chip" data-status="FINALIZADA">Finalizada</div>
  <div class="chip" data-status="SUSPENSA">Suspensa</div>
</div>

<!-- Lista -->
<div class="grid" id="lista">Carregando…</div>





<!-- ================================
     MODAL – LICITAÇÃO
================================ -->
<div class="modal" id="modalLicitacao">
  <div class="content">
    <div class="header">
      <h3 id="tituloModalLicitacao">Nova Licitação</h3>
      <button class="close" data-close="#modalLicitacao">Fechar</button>
    </div>

    <div class="grid-modal">

      <div class="col-6 field">
        <label>INSTITUIÇÃO</label>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="selInstituicao" style="flex:1"></select>
          <button class="btn btn-lite" id="btnNovaEmpresa">+</button>
        </div>
        <div class="help">Clique em "+" para cadastrar empresa.</div>
      </div>

      <div class="col-3 field">
        <label>DATA DA SESSÃO</label>
        <input id="inpData" data-mask="date" placeholder="DD/MM/AAAA">
      </div>

      <div class="col-3 field">
        <label>VALOR TOTAL</label>
        <input id="inpValor" data-mask="money" placeholder="R$ 0,00">
      </div>

      <div class="col-6 field">
        <label>CRITÉRIO</label>
        <input id="inpCriterio" placeholder="MENOR PREÇO GLOBAL">
      </div>

      <div class="col-6 field">
        <label>MODO</label>
        <input id="inpModo" placeholder="ABERTO">
      </div>

      <div class="col-6 field">
        <label>STATUS</label>
        <select id="selStatus">
          <option>Pendente</option>
          <option>Futura</option>
          <option>Em andamento</option>
          <option>Finalizada</option>
          <option>Suspensa</option>
        </select>
      </div>

      <div class="col-12">
        <button class="btn btn-primary" id="btnSalvarLicitacao">SALVAR</button>
      </div>

    </div>
  </div>
</div>





<!-- ================================
     MODAL – EMPRESA
================================ -->
<div class="modal" id="modalEmpresa">
  <div class="content">
    <div class="header">
      <h3>Nova Empresa</h3>
      <button class="close" data-close="#modalEmpresa">Fechar</button>
    </div>

    <div class="grid-modal">

      <div class="col-6 field">
        <label>RAZÃO SOCIAL</label>
        <input id="empRazao">
      </div>

      <div class="col-3 field">
        <label>CNPJ</label>
        <input id="empCnpj">
      </div>

      <div class="col-3 field">
        <label>UF</label>
        <input id="empUf">
      </div>

      <div class="col-12">
        <button class="btn btn-primary" id="btnSalvarEmpresa">SALVAR EMPRESA</button>
      </div>

    </div>
  </div>
</div>





<!-- ================================
     MODAL – ITENS
================================ -->
<div class="modal" id="modalItens">
  <div class="content">
    <div class="header">
      <h3>Itens da Licitação <span id="infoCodigo"></span></h3>
      <button class="close" data-close="#modalItens">Fechar</button>
    </div>

    <div class="row" style="margin-bottom:10px">
      <button class="btn btn-ok" id="btnAddItem">+ Adicionar Item</button>
      <label class="btn btn-lite" for="inpImport">Importar Planilha</label>
      <input id="inpImport" type="file" accept=".xlsx,.csv,.xls" style="display:none">
      <button class="btn btn-ghost" id="btnExportar">Exportar Excel</button>
      <button class="btn btn-ghost" id="btnPdf">Gerar PDF</button>
    </div>

    <div class="table-wrap">
      <table id="tblItens">
        <thead>
          <tr>
            <th>ITEM</th>
            <th>ESPECIFICAÇÃO</th>
            <th>MARCA</th>
            <th>MODELO</th>
            <th>UNID</th>
            <th>QTD MAX</th>
            <th>QTD MIN</th>
            <th>VALOR</th>
            <th>GARANTIA</th>
            <th>AÇÕES</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="grid-modal" style="margin-top:10px">

      <div class="col-2 field">
        <label>ITEM</label>
        <input id="itTR">
      </div>

      <div class="col-5 field">
        <label>ESPECIFICAÇÃO</label>
        <input id="itEsp">
      </div>

      <div class="col-2 field">
        <label>MARCA</label>
        <input id="itMarca">
      </div>

      <div class="col-3 field">
        <label>MODELO</label>
        <input id="itModelo">
      </div>

      <div class="col-2 field">
        <label>UNID.</label>
        <input id="itUnid">
      </div>

      <div class="col-2 field">
        <label>QTD MÁX</label>
        <input id="itQmax">
      </div>

      <div class="col-2 field">
        <label>QTD MIN</label>
        <input id="itQmin">
      </div>

      <div class="col-2 field">
        <label>VALOR</label>
        <input id="itVlr" data-mask="money">
      </div>

      <div class="col-2 field">
        <label>GARANTIA</label>
        <input id="itGarant">
      </div>

      <div class="col-12">
        <button id="btnSalvarItem" class="btn btn-ok">SALVAR ITEM</button>
      </div>

    </div>

  </div>
</div>





<!-- ================================
     MODAL – PRÉVIA IMPORTAÇÃO
================================ -->
<div class="modal" id="modalPreview">
  <div class="content">
    <div class="header">
      <h3>Prévia da Importação</h3>
      <button class="close" data-close="#modalPreview">Fechar</button>
    </div>

    <div class="table-wrap">
      <table id="tblPreview"></table>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnConfirmImport" class="btn btn-primary">Confirmar Importação</button>
    </div>
  </div>
</div>






<!-- ================================
     SCRIPT COMPLETO
================================ -->
<script>

const API = "SEU_WEBAPP_AQUI";  // <-- coloque o link do GAS

const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];

const show = s => $(s).style.display = "flex";
const hide = s => $(s).style.display = "none";

let state = {
  empresas: [],
  licitacoes: [],
  licAtual: null,
  itens: [],
  editIndex: null,
  preview: []
};



/* =============================
   TOAST
=============================*/
function toast(msg, det="", type="err") {
  const t = document.createElement("div");
  t.className = "toast" + (type==="ok"?" ok":type==="warn"?" warn":"");
  t.innerHTML = `<b>${msg}</b>${det?`<small>${det}</small>`:""}`;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),6000);
}



/* =============================
   MASKS
=============================*/
function maskMoney(el){
  let v = el.value.replace(/[^\d]/g,"");
  if(v===""){ el.value=""; return; }
  v = v.padStart(3,"0");
  el.value = "R$ " + v.slice(0,-2).replace(/\B(?=(\d{3})+(?!\d))/g,".") + "," + v.slice(-2);
}

function maskDate(el){
  let v = el.value.replace(/\D/g,"").slice(0,8);
  if(v.length>=5) el.value = v.slice(0,2)+"/"+v.slice(2,4)+"/"+v.slice(4);
  else if(v.length>=3) el.value = v.slice(0,2)+"/"+v.slice(2);
  else el.value = v;
}

function attachMasks(){
  $$('input[data-mask="money"]').forEach(el=>{
    el.addEventListener("input",()=>maskMoney(el));
  });
  $$('input[data-mask="date"]').forEach(el=>{
    el.addEventListener("input",()=>maskDate(el));
  });
}



/* =============================
   API HELPERS
=============================*/
async function apiGet(params){
  const url = API + "?" + new URLSearchParams(params);
  const r = await fetch(url);
  return await r.json();
}

async function apiPost(body){
  const r = await fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  return await r.json();
}



/* =============================
   EMPRESAS
=============================*/
async function carregarEmpresas(){
  const j = await apiGet({action:"listEmpresas"});
  state.empresas = j.empresas || [];
  $("#selInstituicao").innerHTML =
    state.empresas.map(e=>`<option value="${e.codigo}">${e.nome}</option>`).join("");
}

$("#btnNovaEmpresa").onclick = ()=> show("#modalEmpresa");

$("#btnSalvarEmpresa").onclick = async()=>{
  const nome = $("#empRazao").value.trim().toUpperCase();
  if(!nome){ toast("Preencha a razão social"); return; }

  const j = await apiPost({
    action:"addEmpresa",
    nome,
    cnpj: $("#empCnpj").value,
    uf: $("#empUf").value.toUpperCase()
  });

  toast("Empresa cadastrada!", "", "ok");
  hide("#modalEmpresa");
  await carregarEmpresas();
};




/* =============================
   LICITAÇÕES
=============================*/
async function carregarLicitacoes(){
  const j = await apiGet({action:"listLicitacoes"});
  state.licitacoes = j.licitacoes || [];
  renderLista();
}

function renderLista(){
  const filtro = $("#busca").value.toUpperCase();
  const list = $("#lista");

  const dados = state.licitacoes.filter(l =>
    l.instituicao.toUpperCase().includes(filtro)
  );

  if(!dados.length){
    list.innerHTML = "<div style='grid-column:1/-1;color:#64748b'>Nenhuma licitação encontrada.</div>";
    return;
  }

  list.innerHTML = dados.map(l=>{
    const stUI = l.status;
    const stClass = "st-" + stUI.replace(/ /g,"\\ ");

    return `
      <div class="card">
        <h3>${l.instituicao}</h3>
        <small>Código: <b>${l.codigo}</b></small>

        <div class="row">
          <div class="kv">Data: ${l.dataSessaoBR}</div>
          <div class="kv">Valor: ${l.valorBR}</div>
          <div class="kv">Critério: ${l.criterio}</div>
          <div class="kv">Modo: ${l.modo}</div>
        </div>

        <div class="status ${stClass}">${stUI}</div>

        <div class="card-actions">
          <button class="btn btn-ok" onclick="abrirItens('${l.codigo}')">Itens</button>
          <button class="btn btn-lite" onclick="editarLicitacao('${l.codigo}')">Editar</button>
          <button class="btn btn-danger" onclick="excluirLicitacao('${l.codigo}')">Excluir</button>
        </div>
      </div>
    `;
  }).join("");
}



function abrirModalLicitacao(){
  state.licAtual = null;
  $("#tituloModalLicitacao").innerText = "Nova Licitação";
  $("#inpData").value = "";
  $("#inpValor").value = "";
  $("#inpCriterio").value = "";
  $("#inpModo").value = "";
  $("#selStatus").value = "Pendente";
  show("#modalLicitacao");
}


$("#btnSalvarLicitacao").onclick = async()=>{

  const body = {
    instCode: $("#selInstituicao").value,
    instituicao: $("#selInstituicao").selectedOptions[0].text,
    dataSessaoBR: $("#inpData").value,
    valorBR: $("#inpValor").value,
    criterio: $("#inpCriterio").value.toUpperCase(),
    modo: $("#inpModo").value.toUpperCase(),
    status: $("#selStatus").value
  };

  let r;
  if(state.licAtual){
    r = await apiPost({action:"updateLicitacao", codigo:state.licAtual, ...body});
    toast("Licitação atualizada!", "", "ok");
  }else{
    r = await apiPost({action:"addLicitacao", ...body});
    toast("Licitação criada!", `Código: ${r.codigo}`, "ok");
  }

  hide("#modalLicitacao");
  carregarLicitacoes();
};


function editarLicitacao(codigo){
  const l = state.licitacoes.find(x=>x.codigo===codigo);
  if(!l) return;

  state.licAtual = codigo;

  $("#tituloModalLicitacao").innerText = "Editar Licitação";
  $("#selInstituicao").value = l.instCode;
  $("#inpData").value = l.dataSessaoBR;
  $("#inpValor").value = l.valorBR;
  $("#inpCriterio").value = l.criterio;
  $("#inpModo").value = l.modo;
  $("#selStatus").value = l.status;

  show("#modalLicitacao");
}



async function excluirLicitacao(codigo){
  if(!confirm("Excluir licitação?")) return;
  await apiPost({action:"deleteLicitacao", codigo});
  toast("Licitação excluída!", "", "ok");
  carregarLicitacoes();
}




/* =============================
   ITENS
=============================*/

async function abrirItens(codigo){
  state.licAtual = codigo;
  $("#infoCodigo").innerText = "• " + codigo;
  await carregarItens();
  show("#modalItens");
}

async function carregarItens(){
  const j = await apiGet({action:"listItens", codigo:state.licAtual});
  state.itens = j.itens || [];

  $("#tblItens tbody").innerHTML = state.itens.map((i, idx)=>`
    <tr>
      <td>${i.itemTR}</td>
      <td>${i.especificacao}</td>
      <td>${i.marca}</td>
      <td>${i.modelo}</td>
      <td>${i.unidade}</td>
      <td>${i.quantMax}</td>
      <td>${i.quantMin}</td>
      <td>${i.valorUnit}</td>
      <td>${i.garantia}</td>
      <td>
         <button class="btn btn-lite" onclick="editarItem(${idx})">Editar</button>
      </td>
    </tr>
  `).join("");
}

function editarItem(i){
  const x = state.itens[i];
  state.editIndex = i;

  $("#itTR").value = x.itemTR;
  $("#itEsp").value = x.especificacao;
  $("#itMarca").value = x.marca;
  $("#itModelo").value = x.modelo;
  $("#itUnid").value = x.unidade;
  $("#itQmax").value = x.quantMax;
  $("#itQmin").value = x.quantMin;
  $("#itVlr").value = x.valorUnit;
  $("#itGarant").value = x.garantia;

  toast("Editando item...", "", "warn");
}



$("#btnSalvarItem").onclick = async()=>{

  const body = {
    action: state.editIndex!=null ? "updateItem" : "addItem",
    codigoLicitacao: state.licAtual,
    index: state.editIndex,
    itemTR: $("#itTR").value,
    especificacao: $("#itEsp").value.toUpperCase(),
    marca: $("#itMarca").value,
    modelo: $("#itModelo").value,
    unidade: $("#itUnid").value,
    quantMax: $("#itQmax").value,
    quantMin: $("#itQmin").value,
    valorUnit: $("#itVlr").value,
    garantia: $("#itGarant").value
  };

  await apiPost(body);
  toast("Item salvo!", "", "ok");
  state.editIndex = null;

  ["itTR","itEsp","itMarca","itModelo","itUnid","itQmax","itQmin","itVlr","itGarant"]
    .forEach(id=>$("#"+id).value="");

  carregarItens();
};





/* =============================
   IMPORTAÇÃO
=============================*/
$("#inpImport").onchange = async(ev)=>{
  const file = ev.target.files[0];
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data,{type:"array"});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws,{defval:""});

  state.preview = rows;
  montarPreview();
  show("#modalPreview");
};

function montarPreview(){
  const cols = Object.keys(state.preview[0] || {});
  $("#tblPreview").innerHTML =
    "<thead><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr></thead>" +
    "<tbody>" +
    state.preview.map(r=>"<tr>"+cols.map(c=>`<td>${r[c]}</td>`).join("")+"</tr>").join("") +
    "</tbody>";
}

$("#btnConfirmImport").onclick = async()=>{
  await apiPost({
    action:"importItens",
    codigoLicitacao:state.licAtual,
    rows:state.preview
  });

  toast("Itens importados!", "", "ok");
  hide("#modalPreview");
  carregarItens();
};



/* =============================
   EXPORTAÇÃO E PDF
=============================*/
$("#btnExportar").onclick = async()=>{
  const j = await apiGet({action:"exportItens", codigo:state.licAtual});
  if(!j.url){ toast("Não disponível"); return; }
  window.open(j.url);
};

$("#btnPdf").onclick = async()=>{
  const j = await apiGet({action:"gerarPdf", codigo:state.licAtual});
  if(!j.url){ toast("Não disponível"); return; }
  window.open(j.url);
};





/* =============================
   FILTRO E BUSCA
=============================*/
$("#busca").oninput = ()=> renderLista();




/* =============================
   FECHAR MODAL
=============================*/
$$(".close").forEach(btn=>{
  btn.onclick = ()=> hide(btn.dataset.close);
});

$$(".modal").forEach(md=>{
  md.onclick = e=>{
    if(e.target===md) hide("#"+md.id);
  };
});




/* =============================
   INICIALIZAÇÃO
=============================*/
(async function init(){
  attachMasks();
  await carregarEmpresas();
  await carregarLicitacoes();
})();
</script>

</body>
</html>
