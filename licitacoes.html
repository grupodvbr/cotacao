<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LICITAR • Painel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg: #eef1f6;
  --azul: #0a1d37;
  --azul2: #17325a;
  --card: #ffffff;
  --shadow: 0 10px 26px rgba(0,0,0,.12);
  --radius: 14px;
  --ok: #16a34a;
  --danger: #dc2626;
  --muted: #6b7280;
}

/* RESET */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:var(--bg);padding:26px;}

/********** TOPO **********/
.topo{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.titulo{
  font-size:30px;
  font-weight:700;
  color:var(--azul);
}

/********** INPUTS / BOTÕES **********/
.input{
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #d0d4da;
  width:260px;
  background:white;
}
.btn{
  padding:12px 16px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:700;
}
.btn-primary{
  background:var(--azul);
  color:white;
}
.btn-primary:hover{
  background:var(--azul2);
}
.btn-lite{
  background:white;
  border:1px solid #cdd1d8;
  color:var(--azul);
}
.btn-ok{
  background:var(--ok);
  color:white;
}
.btn-danger{
  background:var(--danger);
  color:white;
}

/********** GRID **********/
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:18px;
}

/********** CARD **********/
.card{
  background:white;
  padding:18px;
  border-radius:var(--radius);
  border-left:6px solid var(--azul);
  box-shadow:var(--shadow);
}
.card h3{
  font-size:19px;
  color:var(--azul);
  margin-bottom:6px;
}

/********** STATUS LABEL **********/
.status{
  margin-top:12px;
  display:inline-block;
  padding:6px 10px;
  border-radius:8px;
  font-size:12px;
  font-weight:700;
}
.st-PENDENTE{background:#fff3cd;color:#a15e00;}
.st-FUTURA{background:#dbeafe;color:#1e40af;}
.st-EM_ANDAMENTO{background:#fef9c3;color:#854d0e;}
.st-FINALIZADA{background:#dcfce7;color:#166534;}
.st-SUSPENSA{background:#ffe4e6;color:#9f1239;}

/********** CHIPS (FILTROS) **********/
.chip{
  background:white;
  border:1px solid #cdd1d8;
  padding:8px 14px;
  border-radius:30px;
  cursor:pointer;
  font-size:13px;
  font-weight:600;
}
.chip.ativo{
  background:var(--azul);
  color:white;
  border:none;
}

/********** MODAL **********/
.modal{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,.45);
  padding:20px;
  z-index:99999;
  opacity:0;
  transition:.18s;
}
.modal .content{
  width:100%;
  max-width:900px;
  background:white;
  padding:25px;
  border-radius:16px;
  box-shadow:var(--shadow);
}

/********** TABELAS **********/
table{
  border-collapse:collapse;
  width:100%;
}
th,td{
  border-bottom:1px solid #e5e7eb;
  padding:8px;
  font-size:13px;
}
th{
  background:#f3f4f6;
  font-size:12px;
  text-align:left;
}

/********** OVERLAY **********/
#overlay{
  position:fixed;
  inset:0;
  z-index:10000;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,.4);
}
#overlay .box{
  background:white;
  padding:20px 28px;
  border-radius:16px;
  font-weight:700;
  color:var(--azul);
  font-size:17px;
  box-shadow:var(--shadow);
}
</style>
</head>
<body>

<!-- OVERLAY -->
<div id="overlay"><div class="box">Enviando…</div></div>

<!-- PAINEL PRINCIPAL -->
<div id="painel">
  <div class="topo">
    <div class="titulo">LICITAR • Painel</div>
    <div style="display:flex;gap:10px;align-items:center">
      <input id="busca" class="input" placeholder="BUSCAR..." />
      <button class="btn btn-primary" id="btnNovaLicitacao">+ Nova</button>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
    <div class="chip ativo" data-st="TODOS">Todos</div>
    <div class="chip" data-st="PENDENTE">Pendente</div>
    <div class="chip" data-st="FUTURA">Futura</div>
    <div class="chip" data-st="EM ANDAMENTO">Em andamento</div>
    <div class="chip" data-st="FINALIZADA">Finalizada</div>
    <div class="chip" data-st="SUSPENSA">Suspensa</div>
  </div>

  <div id="lista" class="grid"></div>
</div>

<!-- ======================== MODAL: LICITAÇÃO ======================== -->
<div class="modal" id="modalLicitacao">
  <div class="content">

    <h3 style="font-size:22px;color:var(--azul);margin-bottom:18px" id="tituloModalLicitacao">
      Nova Licitação
    </h3>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">

      <div>
        <label>Instituição</label>
        <div style="display:flex;gap:8px;margin-top:5px">
          <select id="selInstituicao" class="input" style="width:100%"></select>
          <button class="btn btn-lite" id="btnAddEmpresa" style="width:70px">+</button>
        </div>
      </div>

      <div>
        <label>Data</label>
        <input id="inpData" class="input" placeholder="DD/MM/AAAA">
      </div>

      <div>
        <label>Valor Total</label>
        <input id="inpValor" class="input" placeholder="R$ 0,00">
      </div>

      <div>
        <label>Critério</label>
        <input id="inpCriterio" class="input">
      </div>

      <div>
        <label>Modo</label>
        <input id="inpModo" class="input">
      </div>

      <div>
        <label>Status</label>
        <select id="selStatus" class="input">
          <option>PENDENTE</option>
          <option>FUTURA</option>
          <option>EM ANDAMENTO</option>
          <option>FINALIZADA</option>
          <option>SUSPENSA</option>
        </select>
      </div>
    </div>

    <button id="btnSalvarLicitacao" class="btn btn-primary" style="width:100%;margin-top:18px">Salvar</button>
    <button class="btn btn-lite" data-close="#modalLicitacao" style="width:100%;margin-top:10px">Fechar</button>
  </div>
</div>




<!-- ======================== MODAL: EMPRESA ======================== -->
<div class="modal" id="modalEmpresa">
  <div class="content">
    <h3 style="font-size:22px;color:var(--azul);margin-bottom:10px">Nova Empresa</h3>

    <input id="empRazao" class="input" placeholder="Razão Social" style="margin-bottom:10px">
    <input id="empCnpj"  class="input" placeholder="00.000.000/0000-00" style="margin-bottom:10px">
    <input id="empUf"    class="input" placeholder="UF" style="margin-bottom:10px">

    <button id="btnSalvarEmpresa" class="btn btn-primary" style="width:100%">Salvar</button>
    <button class="btn btn-lite" data-close="#modalEmpresa" style="width:100%;margin-top:10px">Fechar</button>
  </div>
</div>




<!-- ======================== MODAL: ITENS ======================== -->
<div class="modal" id="modalItens">
  <div class="content">

    <h3 style="font-size:22px;color:var(--azul);margin-bottom:10px">
      Itens da Licitação <span id="spCodigoItens"></span>
    </h3>

    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button id="btnAddItem" class="btn btn-ok">+ Item</button>

      <label class="btn btn-lite">
        Importar Planilha
        <input type="file" id="inpImportar" accept=".xlsx,.xls,.csv" style="display:none">
      </label>

      <button id="btnExportar" class="btn btn-lite">Excel</button>
      <button id="btnGerarPdf" class="btn btn-lite">PDF</button>
    </div>

    <table id="tblItens">
      <thead>
        <tr>
          <th>TR</th><th>ESPECIFICAÇÃO</th><th>MARCA</th><th>MODELO</th>
          <th>UN</th><th>MAX</th><th>MIN</th><th>VALOR</th><th>GARANTIA</th><th>AÇÕES</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h4 style="margin-top:22px;font-size:15px;color:var(--azul)">Cadastrar Item</h4>

    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:8px">
      <input id="itTR"     class="input" placeholder="TR">
      <input id="itESP"    class="input" placeholder="ESPECIFICAÇÃO">
      <input id="itMARCA"  class="input" placeholder="MARCA">
      <input id="itMODELO" class="input" placeholder="MODELO">
      <input id="itUN"     class="input" placeholder="UN">

      <input id="itMAX" class="input" placeholder="MAX">
      <input id="itMIN" class="input" placeholder="MIN">
      <input id="itVLR" class="input" placeholder="VALOR">
      <input id="itGAR" class="input" placeholder="GARANTIA">
    </div>

    <button id="btnSalvarItem" class="btn btn-ok" style="width:100%;margin-top:14px">Salvar Item</button>
    <button class="btn btn-lite" data-close="#modalItens" style="width:100%;margin-top:10px">Fechar</button>

  </div>
</div>




<!-- ======================== MODAL: PRÉVIA ======================== -->
<div class="modal" id="modalPreview">
  <div class="content">

    <h3 style="font-size:22px;color:var(--azul);margin-bottom:10px">Prévia da Importação</h3>

    <table id="tblPreview"></table>

    <button id="btnConfirmarImport" class="btn btn-primary" style="width:100%;margin-top:14px">
      Confirmar Importação
    </button>
    <button class="btn btn-lite" data-close="#modalPreview" style="width:100%;margin-top:10px">Fechar</button>

  </div>
</div>





<!-- ======================== JS COMPLETO ======================== -->
<script>
/* ==========================================================
        CONFIG
========================================================== */
const API = "https://script.google.com/macros/s/AKfycbzKyN0FAdv-i7ObZRdDNVnCaieLpai1sQOAytVfH4BLf_KIOuWR3zpfh_-gDYK_0f5U/exec";

let estado = {
  empresas: [],
  licitacoes: [],
  itens: [],
  preview: [],
  licAtual: null,
  filtro: "TODOS",
  busca: ""
};

const $  = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];


/* ==========================================================
        OVERLAY
========================================================== */
function overlay(v=true){
  $("#overlay").style.display = v ? "flex" : "none";
}

/* ==========================================================
        SHOW / HIDE MODAL
========================================================== */
function show(id){
  const el = $(id);
  el.style.display = "flex";
  setTimeout(()=> el.style.opacity = 1, 15);
}
function hide(id){
  const el = $(id);
  el.style.opacity = 0;
  setTimeout(()=> el.style.display = "none", 180);
}

document.addEventListener("click", e=>{
  const c = e.target.getAttribute("data-close");
  if(c) hide(c);
});


/* ==========================================================
        INICIALIZAÇÃO
========================================================== */
document.addEventListener("DOMContentLoaded", ()=>{
  carregarEmpresas();
  carregarLicitacoes();
  configurarEventos();
});


/* ==========================================================
        EVENTOS GLOBAIS
========================================================== */
function configurarEventos(){

  $("#btnNovaLicitacao").onclick = abrirNovaLicitacao;
  $("#btnAddEmpresa").onclick = ()=> show("#modalEmpresa");

  $("#btnSalvarEmpresa").onclick = salvarEmpresa;
  $("#btnSalvarLicitacao").onclick = salvarLicitacao;
  $("#btnSalvarItem").onclick = salvarItem;

  $("#inpImportar").onchange = previewImportacao;
  $("#btnConfirmarImport").onclick = confirmarImportacao;

  $("#btnExportar").onclick = ()=> exportarItens(estado.licAtual);
  $("#btnGerarPdf").onclick = ()=> gerarPdf(estado.licAtual);

  $("#busca").oninput = e=>{
    estado.busca = e.target.value.toUpperCase();
    renderLista();
  };

  $$(".chip").forEach(c=>{
    c.onclick = ()=>{
      $$(".chip").forEach(x=>x.classList.remove("ativo"));
      c.classList.add("ativo");
      estado.filtro = c.dataset.st;
      renderLista();
    };
  });
}


/* ==========================================================
        EMPRESAS
========================================================== */
async function carregarEmpresas(){
  const r = await fetch(`${API}?action=listEmpresas`);
  const j = await r.json();
  estado.empresas = j.empresas || [];
  $("#selInstituicao").innerHTML =
    estado.empresas.map(e=>`<option value="${e.codigo}">${e.nome}</option>`).join("");
}

async function salvarEmpresa(){
  const nome = $("#empRazao").value.trim();
  const cnpj = $("#empCnpj").value.trim();
  const uf   = $("#empUf").value.trim().toUpperCase();

  if(!nome) return alert("Informe o nome da empresa.");

  overlay(true);
  const r = await fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"addEmpresa",nome,cnpj,uf})
  });
  overlay(false);

  const j = await r.json();
  if(j.error) return alert(j.error);

  hide("#modalEmpresa");
  carregarEmpresas();
}


/* ==========================================================
        LICITAÇÕES
========================================================== */
async function carregarLicitacoes(){
  const r = await fetch(`${API}?action=listLicitacoes`);
  const j = await r.json();
  estado.licitacoes = j.licitacoes || [];
  renderLista();
}

function abrirNovaLicitacao(){
  estado.licAtual = null;
  $("#tituloModalLicitacao").innerText = "Nova Licitação";

  $("#inpData").value = "";
  $("#inpValor").value = "";
  $("#inpCriterio").value = "";
  $("#inpModo").value = "";
  $("#selStatus").value = "PENDENTE";

  show("#modalLicitacao");
}

function editarLicitacao(codigo){
  const l = estado.licitacoes.find(x=>x.codigo===codigo);
  if(!l) return;

  estado.licAtual = codigo;

  $("#tituloModalLicitacao").innerText = "Editar Licitação";

  $("#selInstituicao").value = l.instCode;
  $("#inpData").value = l.dataSessaoBR;
  $("#inpValor").value = l.valorBR;
  $("#inpCriterio").value = l.criterio;
  $("#inpModo").value = l.modo;
  $("#selStatus").value = l.status;

  show("#modalLicitacao");
}

async function salvarLicitacao(){

  const instCode     = $("#selInstituicao").value;
  const instituicao  = $("#selInstituicao").selectedOptions[0].textContent;
  const dataSessaoBR = $("#inpData").value.trim();
  const valorBR      = $("#inpValor").value.trim();
  const criterio     = $("#inpCriterio").value.trim();
  const modo         = $("#inpModo").value.trim();
  const status       = $("#selStatus").value.trim();

  if(!instCode) return alert("Selecione uma instituição.");
  if(!dataSessaoBR) return alert("Informe a data.");
  if(!valorBR) return alert("Informe o valor.");

  const body = {
    action: estado.licAtual ? "updateLicitacao" : "addLicitacao",
    codigo: estado.licAtual,
    instCode,
    instituicao,
    dataSessaoBR,
    valorBR,
    criterio,
    modo,
    status
  };

  overlay(true);
  const r = await fetch(API,{method:"POST",body:JSON.stringify(body)});
  overlay(false);

  const j = await r.json();
  if(j.error) return alert(j.error);

  hide("#modalLicitacao");
  carregarLicitacoes();
}

async function excluirLicitacao(codigo){
  if(!confirm("Excluir licitação?")) return;

  overlay(true);
  const r = await fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"deleteLicitacao",codigo})
  });
  overlay(false);

  const j = await r.json();
  if(j.error) return alert(j.error);

  carregarLicitacoes();
}


/* ==========================================================
        LISTA DE LICITAÇÕES
========================================================== */
function renderLista(){

  const lista  = $("#lista");
  const busca  = estado.busca;
  const filtro = estado.filtro;

  const dados = estado.licitacoes.filter(l=>{
    const okFiltro = filtro==="TODOS" || l.status===filtro;
    const okBusca  = 
         l.instituicao.toUpperCase().includes(busca)
      || l.codigo.toUpperCase().includes(busca);
    return okFiltro && okBusca;
  });

  if(!dados.length){
    lista.innerHTML = `<div style="color:#666">Nenhuma licitação encontrada.</div>`;
    return;
  }

  lista.innerHTML = dados.map(l=>`
    <div class="card">
      <h3>${l.instituicao}</h3>
      <small>Código <b>${l.codigo}</b></small><br>
      <small>Data: ${l.dataSessaoBR}</small><br>
      <small>Valor: ${l.valorBR}</small><br>
      <small>Critério: ${l.criterio}</small><br>
      <small>Modo: ${l.modo}</small>

      <div class="status st-${l.status.replace(/ /g,"_")}">${l.status}</div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button class="btn btn-ok" onclick="abrirItens('${l.codigo}')">Itens</button>
        <button class="btn btn-lite" onclick="editarLicitacao('${l.codigo}')">Editar</button>
        <button class="btn btn-danger" onclick="excluirLicitacao('${l.codigo}')">Excluir</button>
        <button class="btn btn-lite" onclick="exportarItens('${l.codigo}')">Excel</button>
        <button class="btn btn-lite" onclick="gerarPdf('${l.codigo}')">PDF</button>
      </div>
    </div>
  `).join("");
}


/* ==========================================================
        ITENS
========================================================== */
async function abrirItens(codigo){

  estado.licAtual = codigo;
  $("#spCodigoItens").innerText = codigo;

  overlay(true);
  const r = await fetch(`${API}?action=listItens&codigo=${codigo}`);
  overlay(false);

  const j = await r.json();
  estado.itens = j.itens || [];

  renderItens();
  show("#modalItens");
}

function renderItens(){

  const tbody = $("#tblItens tbody");

  if(!estado.itens.length){
    tbody.innerHTML = `<tr><td colspan="10" style="padding:10px;color:#666">Nenhum item.</td></tr>`;
    return;
  }

  tbody.innerHTML = estado.itens.map((i,idx)=>`
    <tr>
      <td>${i.itemTR}</td>
      <td>${i.especificacao}</td>
      <td>${i.marca}</td>
      <td>${i.modelo}</td>
      <td>${i.unidade}</td>
      <td>${i.quantMax}</td>
      <td>${i.quantMin}</td>
      <td>${i.valorUnit}</td>
      <td>${i.garantia}</td>
      <td><button class="btn btn-lite" onclick="deleteItem(${idx})">X</button></td>
    </tr>
  `).join("");
}

async function salvarItem(){

  if(!estado.licAtual) return alert("Nenhuma licitação aberta.");

  const body = {
    action:"addItem",
    codigoLicitacao: estado.licAtual,
    itemTR: $("#itTR").value.trim(),
    especificacao: $("#itESP").value.trim(),
    marca: $("#itMARCA").value.trim(),
    modelo: $("#itMODELO").value.trim(),
    unidade: $("#itUN").value.trim(),
    quantMax: $("#itMAX").value.trim(),
    quantMin: $("#itMIN").value.trim(),
    valorUnit: $("#itVLR").value.trim(),
    garantia: $("#itGAR").value.trim()
  };

  overlay(true);
  const r = await fetch(API,{method:"POST",body:JSON.stringify(body)});
  overlay(false);

  const j = await r.json();
  if(j.error) return alert(j.error);

  abrirItens(estado.licAtual);
}

async function deleteItem(idx){

  if(!confirm("Excluir item?")) return;

  overlay(true);
  const r = await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"deleteItem",
      codigoLicitacao:estado.licAtual,
      idx
    })
  });
  overlay(false);

  const j = await r.json();
  if(j.error) return alert(j.error);

  abrirItens(estado.licAtual);
}


/* ==========================================================
        IMPORTAÇÃO XLS
========================================================== */
function previewImportacao(ev){
  const file = ev.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = e=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data,{type:"array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    estado.preview = XLSX.utils.sheet_to_json(ws);
    gerarPreviewTabela();
    show("#modalPreview");
  };

  reader.readAsArrayBuffer(file);
}

function gerarPreviewTabela(){

  const tbl = $("#tblPreview");

  if(!estado.preview.length){
    tbl.innerHTML = `<tr><td>Nenhum dado encontrado</td></tr>`;
    return;
  }

  const cols = Object.keys(estado.preview[0]);

  tbl.innerHTML =
    `<tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr>` +
    estado.preview.map(row=>
      `<tr>${cols.map(c=>`<td>${row[c]||""}</td>`).join("")}</tr>`
    ).join("");
}

async function confirmarImportacao(){

  overlay(true);
  const r = await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"importItens",
      codigoLicitacao:estado.licAtual,
      rows:estado.preview
    })
  });
  overlay(false);

  const j = await r.json();
  if(j.error) return alert(j.error);

  hide("#modalPreview");
  abrirItens(estado.licAtual);
}


/* ==========================================================
        EXPORTAÇÃO / PDF
========================================================== */
async function exportarItens(codigo){
  overlay(true);
  const r = await fetch(`${API}?action=exportItens&codigo=${codigo}`);
  overlay(false);

  const j = await r.json();
  if(!j.url) return alert("Erro ao exportar.");

  window.open(j.url,"_blank");
}

async function gerarPdf(codigo){
  overlay(true);
  const r = await fetch(`${API}?action=gerarPdf&codigo=${codigo}`);
  overlay(false);

  const j = await r.json();
  if(!j.url) return alert("Erro ao gerar PDF.");
  window.open(j.url,"_blank");
}


/* ==========================================================
        MÁSCARAS
========================================================== */
function maskData(input){
  input.value = input.value
    .replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"$1/$2")
    .replace(/(\d{2})(\d)/,"$1/$2")
    .replace(/(\d{4}).*/,"$1");
}
$("#inpData").addEventListener("input", e=> maskData(e.target));

function maskMoney(input){
  let v = input.value.replace(/\D/g,"");
  v = (v/100).toFixed(2);
  v = v.replace(".",",");
  v = v.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  input.value = "R$ " + v;
}
$("#inpValor").addEventListener("input", e=> maskMoney(e.target));
$("#itVLR").addEventListener("input", e=> maskMoney(e.target));

function maskCNPJ(input){
  input.value = input.value
    .replace(/\D/g,"")
    .replace(/^(\d{2})(\d)/,"$1.$2")
    .replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3")
    .replace(/\.(\d{3})(\d)/,".$1/$2")
    .replace(/(\d{4})(\d)/,"$1-$2")
    .replace(/(-\d{2})\d+$/,"$1");
}
$("#empCnpj").addEventListener("input", e=> maskCNPJ(e.target));

$("#empUf").addEventListener("input", e=>{
  e.target.value = e.target.value.toUpperCase().substring(0,2);
});

/* maiúsculas */
[
  "#inpCriterio",
  "#inpModo",
  "#itTR",
  "#itESP",
  "#itMARCA",
  "#itMODELO",
  "#itUN",
  "#itMAX",
  "#itMIN",
  "#itGAR"
].forEach(id=>{
  const el = document.querySelector(id);
  if(el) el.addEventListener("input", e=> e.target.value = e.target.value.toUpperCase());
});

</script>
</body>
</html>
