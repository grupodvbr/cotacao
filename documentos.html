<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ Sistema de Licita√ß√µes</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* =========================
   GERAL
========================= */
body {
  font-family: 'Inter', sans-serif;
  background: #eef1f7;
  margin: 0;
  padding: 20px;
}

/* =========================
   CONTAINER
========================= */
#container {
  max-width: 1100px;
  margin: 0 auto;
  background: white;
  padding: 20px 30px;
  border-radius: 16px;
  box-shadow: 0 4px 18px rgba(0,0,0,0.12);
}

#titulo {
  text-align: center;
  color: #2b313f;
  font-size: 26px;
  margin-bottom: 20px;
}

/* =========================
   TOOLBAR
========================= */
.toolbar {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: white;
  font-weight: 600;
  font-size: 14px;
  transition: 0.2s;
}

.btn:hover { opacity: 0.85; }

.btn-nova {
  background: #2563eb;
}
.btn-upload {
  background: #7e22ce;
}

input[type="file"] {
  display: none;
}

/* =========================
   LISTA TREE VIEW
========================= */
.arvore-item {
  display: flex;
  align-items: center;
  gap: 12px;
  background: #f7f9fe;
  padding: 10px;
  border-radius: 8px;
  margin-top: 8px;
  transition: 0.2s;
}

.arvore-item:hover {
  background: #eef4ff;
}

.child {
  margin-left: 28px;
}

/* Op√ß√µes */
.opcoes {
  margin-left: auto;
  display: flex;
  gap: 6px;
}

.acao {
  padding: 4px 10px;
  background: #ddd;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.acao:hover { background: #ccc; }

/* =========================
   MODAL PREVIEW
========================= */
#modal {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#modalBox {
  background:white;
  width:90%;
  max-width:700px;
  border-radius:14px;
  padding:25px;
  box-shadow:0 0 20px rgba(0,0,0,0.3);
}

#modalClose {
  float:right;
  background:#ef4444;
  color:white;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}

#modalPreview {
  width:100%;
  height:420px;
  margin-top:15px;
  border-radius:8px;
  border:none;
  background:#f5f5f5;
}

/* =========================
   POPUP CRIAR PASTA
========================= */
#popupCriar {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
}
#popupBox {
  background:white;
  padding:25px;
  width:90%; max-width:450px;
  border-radius:12px;
}

.colorSelect {
  width:32px;
  height:32px;
  border-radius:50%;
  cursor:pointer;
  border:3px solid transparent;
  transition: 0.2s;
}

.colorSelect.active {
  border:3px solid #111;
  transform: scale(1.1);
}

.colorRow {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}

/* Drag highlight */
.drop-hover {
  border: 2px dashed #2563eb;
}

</style>
</head>

<body>

<div id="container">

  <h1 id="titulo">GERENCIADOR DE DOCUMENTOS</h1>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>

    <label for="uploadInput">
      <button class="btn btn-upload">‚¨Ü Upload</button>
    </label>
    <input type="file" id="uploadInput" onchange="uploadFile(event)">
  </div>

  <!-- LISTA -->
  <div id="lista">Carregando documentos...</div>

</div>

<!-- POPUP CRIAR PASTA -->
<div id="popupCriar">
  <div id="popupBox">
    <h3>Criar nova pasta</h3>

    <label>Nome da pasta</label>
    <input id="nomePasta" type="text" style="width:100%;padding:8px;margin-top:6px;">

    <p>Cor:</p>
    <div class="colorRow">
      <div class="colorSelect" style="background:#2563eb" data-cor="azul"></div>
      <div class="colorSelect" style="background:#4caf50" data-cor="verde"></div>
      <div class="colorSelect" style="background:#facc15" data-cor="amarelo"></div>
      <div class="colorSelect" style="background:#fb923c" data-cor="laranja"></div>
      <div class="colorSelect" style="background:#ef4444" data-cor="vermelho"></div>
      <div class="colorSelect" style="background:#a855f7" data-cor="roxo"></div>
      <div class="colorSelect" style="background:#737373" data-cor="cinza"></div>
      <div class="colorSelect" style="background:#000000" data-cor="preto"></div>
      <div class="colorSelect" style="background:#ec4899" data-cor="rosa"></div>
      <div class="colorSelect" style="background:#8b5e3c" data-cor="marrom"></div>
    </div>

    <br>
    <button onclick="criarPasta()" class="btn btn-nova" style="width:100%;">Criar</button>
    <button onclick="fecharPopupCriar()" style="margin-top:10px;border:none;background:#ddd;padding:8px;width:100%;border-radius:6px;cursor:pointer;">Cancelar</button>
  </div>
</div>

<!-- MODAL -->
<div id="modal">
  <div id="modalBox">
    <button id="modalClose" onclick="fecharModal()">Fechar</button>
    <h2 id="modalTitulo"></h2>
    <iframe id="modalPreview"></iframe>
    <br><br>
    <button onclick="baixarArquivo()" class="btn btn-upload">‚¨á Download</button>
    <button onclick="copiarLink()" class="btn btn-nova">üîó Copiar Link</button>
  </div>
</div>

<script>

/* CONFIG */
const API = "https://script.google.com/macros/s/AKfycbyufyQuT4p-ifUvwSCfqROCpdNCiyk92OUrRRfLSmtghJRXyxEcyVDa_648lBtcRorb0w/exec";
let usuario = localStorage.getItem("usuarioLogado") || "desconhecido";
let dados = [];
let corEscolhida = null;
let arrastando = null;

/* ===============================
   CARREGAR LISTA
================================*/
async function carregar(){
  document.getElementById("lista").innerHTML = "Carregando...";

  const req = await fetch(API + "?action=listar");
  dados = await req.json();

  renderArvore();
}

/* ===============================
   √ÅRVORE
================================*/
function renderArvore() {
  let html = "";
  const raiz = dados.filter(p => p.pai === "10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp");

  raiz.forEach(p => html += renderItem(p));
  document.getElementById("lista").innerHTML = html;
}

function renderItem(item) {
  let html = "";

  if(item.tipo === "pasta") {
    html += `
    <div class="arvore-item" draggable="true"
         ondragstart="dragStart('${item.id}')"
         ondragover="dragOver(event)"
         ondrop="soltar('${item.id}')"
    >
      ${svgCor(item.capa)}
      <span onclick="toggleFolder('${item.id}')">${item.nome}</span>

      <div class="opcoes">
        <span class="acao" onclick="renomear('${item.id}','${item.nome}')">Renomear</span>
        <span class="acao" onclick="excluir('${item.id}','${item.nome}')">Excluir</span>
      </div>
    </div>
    `;

    const filhos = dados.filter(p => p.pai === item.id);

    if(filhos.length) {
      html += `<div id="child-${item.id}" class="child" style="display:none">`;
      filhos.forEach(f => html += renderItem(f));
      html += "</div>";
    }

  } else {
    html += `
    <div class="arvore-item child" draggable="true"
         ondragstart="dragStart('${item.id}')"
    >
      üìÑ <span onclick="abrirArquivo('${item.nome}','${item.url}')">${item.nome}</span>

      <div class="opcoes">
        <span class="acao" onclick="renomear('${item.id}','${item.nome}')">Renomear</span>
        <span class="acao" onclick="excluir('${item.id}','${item.nome}')">Excluir</span>
      </div>
    </div>
    `;
  }

  return html;
}

/* ===============================
   TOGGLE PASTA
================================*/
function toggleFolder(id){
  const div = document.getElementById("child-" + id);
  if(div) {
    div.style.display = div.style.display === "none" ? "block" : "none";
  }
}

/* ===============================
   SVG DAS PASTAS
================================*/
function svgCor(cor){
  const cores = {
    azul:"#2563eb",
    verde:"#4caf50",
    amarelo:"#facc15",
    laranja:"#fb923c",
    vermelho:"#ef4444",
    roxo:"#a855f7",
    cinza:"#737373",
    preto:"#000000",
    rosa:"#ec4899",
    marrom:"#8b5e3c"
  };

  return `
  <svg width="28" height="22" viewBox="0 0 24 24">
    <path fill="${cores[cor] || '#2563eb'}" d="M10 4l2 2h8a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h6z"/>
  </svg>
  `;
}

/* ===============================
   POPUP CRIAR PASTA
================================*/
function abrirPopupCriar(){
  document.getElementById("popupCriar").style.display = "flex";
}

function fecharPopupCriar(){
  document.getElementById("popupCriar").style.display = "none";
  document.getElementById("nomePasta").value = "";
  corEscolhida = null;
  document.querySelectorAll(".colorSelect").forEach(c=>c.classList.remove("active"));
}

document.querySelectorAll(".colorSelect").forEach(c=>{
  c.onclick = function(){
    document.querySelectorAll(".colorSelect").forEach(el=>el.classList.remove("active"));
    c.classList.add("active");
    corEscolhida = c.dataset.cor;
  };
});

function criarPasta(){
  const nome = document.getElementById("nomePasta").value.trim();
  if(!nome){ alert("Digite o nome da pasta"); return; }
  if(!corEscolhida){ alert("Escolha uma cor"); return; }

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"criarPasta",
      nome:nome,
      cor:corEscolhida,
      usuario:usuario,
      pai:null
    })
  }).then(()=>{
    fecharPopupCriar();
    carregar();
  });
}

/* ===============================
   RENOMEAR
================================*/
function renomear(id, nome){
  const novo = prompt("Novo nome:", nome);
  if(!novo) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"renomear",
      id:id,
      novoNome:novo,
      usuario:usuario
    })
  }).then(()=>carregar());
}

/* ===============================
   EXCLUIR
================================*/
function excluir(id, nome){
  if(!confirm("Excluir " + nome + "?")) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"excluir",
      id:id,
      nome:nome,
      usuario:usuario
    })
  }).then(()=>carregar());
}

/* ===============================
   UPLOAD
================================*/
function uploadFile(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(){
    const base64 = reader.result.split(",")[1];

    fetch(API,{
      method:"POST",
      body:JSON.stringify({
        action:"upload",
        base64:base64,
        mime:file.type,
        nome:file.name,
        usuario:usuario,
        pai:null
      })
    }).then(()=>carregar());
  }
  reader.readAsDataURL(file);
}

/* ===============================
   DRAG & DROP ‚Äî MOVER
================================*/
function dragStart(id){
  arrastando = id;
}
function dragOver(e){ e.preventDefault(); }

function soltar(novoPai){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"mover",
      id:arrastando,
      novoPai:novoPai,
      usuario:usuario
    })
  }).then(()=>carregar());
}

/* ===============================
   MODAL ARQUIVO
================================*/
let linkAtual = "";

function abrirArquivo(nome, url){
  document.getElementById("modalTitulo").innerText = nome;
  document.getElementById("modalPreview").src = url;
  linkAtual = url;

  document.getElementById("modal").style.display = "flex";
}

function fecharModal(){
  document.getElementById("modal").style.display = "none";
}

function baixarArquivo(){
  window.open(linkAtual, "_blank");
}

function copiarLink(){
  navigator.clipboard.writeText(linkAtual);
  alert("Link copiado!");
}

/* CARREGAR IN√çCIO */
carregar();

</script>
</body>
</html>
