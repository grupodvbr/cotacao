<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ Sistema de Licita√ß√µes</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  background:#f5f6fa;
  margin:0;padding:20px;
}
h1{
  text-align:center;
  margin-bottom:20px;
}

/* CONTAINER */
#container{
  max-width:900px;
  margin:0 auto;
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 0 15px rgba(0,0,0,0.1);
}

/* PASTAS */
.folder, .subfolder {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  margin-top:10px;
  border-radius:8px;
  background:#eef2ff;
  cursor:pointer;
}

.subfolder { margin-left:25px; background:#f5f7ff; }

.file{
  margin-left:50px;
  padding:6px;
  display:flex;
  align-items:center;
  gap:10px;
}

.opcoes{
  margin-left:auto;
  display:flex;
  gap:5px;
}

.acaoBtn{
  padding:3px 8px;
  background:#ddd;
  font-size:12px;
  border-radius:6px;
  cursor:pointer;
}

#btnNovaPasta, #btnUpload{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

#btnNovaPasta{background:#1a73e8;color:white;}
#btnUpload{background:#673ab7;color:white;margin-left:8px;}

input[type="file"]{ display:none; }

/* MODAL */
#modal{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
#modalBox{
  background:white;
  padding:20px;
  border-radius:12px;
  width:90%; max-width:600px;
}
#modalClose{
  background:#ff5252;
  color:white;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  float:right;
}

/* POPUP CRIAR PASTA */
#popupCriar{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
}
#popupBox{
  background:white;
  padding:20px;
  border-radius:12px;
  width:90%; max-width:400px;
}
.colorSelect{
  width:28px;
  height:28px;
  border-radius:50%;
  cursor:pointer;
  border:2px solid transparent;
}
.colorSelect.active{
  border:3px solid black;
}

/* DRAG DROP DESTINO */
.dropzone{
  border:2px dashed #bbb;
  padding:10px;
  border-radius:10px;
  text-align:center;
  display:none;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>GERENCIADOR DE DOCUMENTOS</h1>

<div id="container">

  <!-- BOT√ïES -->
  <div>
    <button id="btnNovaPasta" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <label for="uploadInput">
      <button id="btnUpload">‚¨Ü Upload</button>
    </label>
    <input type="file" id="uploadInput" onchange="fazerUpload(event)">
  </div>

  <!-- LISTAGEM -->
  <div id="lista" style="margin-top:20px;">Carregando documentos...</div>

</div>

<!-- POPUP CRIAR PASTA -->
<div id="popupCriar">
  <div id="popupBox">
    <h3>Criar nova pasta</h3>

    <label>Nome:</label>
    <input type="text" id="novaPastaNome" style="width:100%;padding:8px;margin-top:5px">

    <p>Escolha a cor:</p>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div class="colorSelect" style="background:#2d7ff9" data-cor="azul"></div>
      <div class="colorSelect" style="background:#4caf50" data-cor="verde"></div>
      <div class="colorSelect" style="background:#f7d339" data-cor="amarelo"></div>
      <div class="colorSelect" style="background:#ff9800" data-cor="laranja"></div>
      <div class="colorSelect" style="background:#f44336" data-cor="vermelho"></div>
      <div class="colorSelect" style="background:#8e24aa" data-cor="roxo"></div>
      <div class="colorSelect" style="background:#9e9e9e" data-cor="cinza"></div>
      <div class="colorSelect" style="background:#000000" data-cor="preto"></div>
      <div class="colorSelect" style="background:#ec407a" data-cor="rosa"></div>
      <div class="colorSelect" style="background:#795548" data-cor="marrom"></div>
    </div>

    <br>
    <button onclick="criarPasta()" style="background:#1a73e8;color:white;padding:8px 14px;border:none;border-radius:8px;">Criar</button>
    <button onclick="fecharPopupCriar()" style="padding:8px 14px;border-radius:8px;border:none;">Cancelar</button>
  </div>
</div>

<!-- MODAL DE ARQUIVO -->
<div id="modal">
  <div id="modalBox">
    <button id="modalClose" onclick="fecharModal()">Fechar</button>
    <h2 id="modalTitulo"></h2>
    <iframe id="modalPreview" style="width:100%;height:400px;border:none;"></iframe>
    <br><br>
    <button onclick="baixarArquivo()">‚¨á Baixar</button>
    <button onclick="copiarLink()">üîó Copiar Link</button>
  </div>
</div>

<script>
/* CONFIG */
const API = "https://script.google.com/macros/s/AKfycbyufyQuT4p-ifUvwSCfqROCpdNCiyk92OUrRRfLSmtghJRXyxEcyVDa_648lBtcRorb0w/exec";
let usuario = localStorage.getItem("usuarioLogado") || "desconhecido";

let dadosEstrutura = [];
let pastaSelecionada = null;
let corEscolhida = null;

/* ===============================
   POPUP CRIAR PASTA
================================*/
function abrirPopupCriar(){
  document.getElementById("popupCriar").style.display = "flex";
}
function fecharPopupCriar(){
  document.getElementById("popupCriar").style.display = "none";
  document.getElementById("novaPastaNome").value = "";
  corEscolhida = null;
  document.querySelectorAll(".colorSelect").forEach(c=>c.classList.remove("active"));
}

document.querySelectorAll(".colorSelect").forEach(el=>{
  el.onclick = () => {
    document.querySelectorAll(".colorSelect").forEach(c=>c.classList.remove("active"));
    el.classList.add("active");
    corEscolhida = el.dataset.cor;
  };
});

/* ===============================
   GERAR SVG DA PASTA POR COR
================================*/
function svgCor(cor){
  const cores = {
    azul:"#2d7ff9",
    verde:"#4caf50",
    amarelo:"#f7d339",
    laranja:"#ff9800",
    vermelho:"#f44336",
    roxo:"#8e24aa",
    cinza:"#9e9e9e",
    preto:"#000000",
    rosa:"#ec407a",
    marrom:"#795548"
  };

  const c = cores[cor] || "#2d7ff9";

  return `
  <svg width="26" height="22" viewBox="0 0 24 24">
    <path fill="${c}" d="M10 4l2 2h8a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6
    a2 2 0 012-2h6z"/>
  </svg>`;
}

/* ===============================
   LISTAGEM
================================*/
async function carregar(){
  document.getElementById("lista").innerHTML = "Carregando...";

  const req = await fetch(API+"?action=listar");
  dadosEstrutura = await req.json();

  montarArvore();
}

function montarArvore(){
  const root = dadosEstrutura.filter(i => i.pai === "10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp");

  let html = "";
  root.forEach(p => html += renderItem(p, 0));

  document.getElementById("lista").innerHTML = html;
}

function renderItem(item, nivel){
  let html = "";

  if(item.tipo === "pasta"){
    html += `
      <div class="folder" draggable="true"
        ondragstart="dragStart('${item.id}')"
        ondragover="permitirSoltar(event)"
        ondrop="soltar('${item.id}')"
      >
        ${svgCor(item.capa)}
        <span onclick="abrirPasta('${item.id}')">${item.nome}</span>

        <div class="opcoes">
          <span class="acaoBtn" onclick="renomear('${item.id}', '${item.nome}')">Renomear</span>
          <span class="acaoBtn" onclick="excluir('${item.id}', '${item.nome}')">Excluir</span>
        </div>
      </div>
    `;

    const filhos = dadosEstrutura.filter(i => i.pai === item.id);
    filhos.forEach(f => {
      html += `
        <div style="margin-left:25px;">
          ${renderItem(f, nivel+1)}
        </div>`;
    });

  } else {
    html += `
      <div class="file" draggable="true"
        ondragstart="dragStart('${item.id}')"
      >
        üìÑ <span onclick="abrirArquivo('${item.nome}', '${item.url}')">${item.nome}</span>

        <div class="opcoes">
          <span class="acaoBtn" onclick="renomear('${item.id}', '${item.nome}')">Renomear</span>
          <span class="acaoBtn" onclick="excluir('${item.id}', '${item.nome}')">Excluir</span>
        </div>
      </div>
    `;
  }

  return html;
}

/* ===============================
   CRIAR PASTA
================================*/
function criarPasta(){
  const nome = document.getElementById("novaPastaNome").value.trim();
  if(!nome){ alert("Informe o nome."); return; }
  if(!corEscolhida){ alert("Escolha uma cor."); return; }

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"criarPasta",
      nome:nome,
      cor:corEscolhida,
      usuario:usuario,
      pai:null
    })
  }).then(()=>{
    fecharPopupCriar();
    carregar();
  });
}

/* ===============================
   RENOMEAR
================================*/
function renomear(id, nome){
  const novo = prompt("Novo nome:", nome);
  if(!novo) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"renomear",
      id:id,
      novoNome:novo,
      usuario:usuario
    })
  }).then(()=>carregar());
}

/* ===============================
   EXCLUIR
================================*/
function excluir(id, nome){
  if(!confirm("Excluir "+nome+"?")) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"excluir",
      id:id,
      nome:nome,
      usuario:usuario
    })
  }).then(()=>carregar());
}

/* ===============================
   UPLOAD
================================*/
function fazerUpload(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(){
    const base64 = reader.result.split(",")[1];

    fetch(API,{
      method:"POST",
      body:JSON.stringify({
        action:"upload",
        base64:base64,
        mime:file.type,
        nome:file.name,
        usuario:usuario,
        pai:null
      })
    }).then(()=>carregar());
  };
  reader.readAsDataURL(file);
}

/* ===============================
   DRAG & DROP (MOVER)
================================*/
let itemArrastado = null;

function dragStart(id){ itemArrastado = id; }
function permitirSoltar(e){ e.preventDefault(); }

function soltar(novoPai){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"mover",
      id:itemArrastado,
      novoPai:novoPai,
      usuario:usuario
    })
  }).then(()=>carregar());
}

/* ===============================
   MODAL ARQUIVO
================================*/
let linkAtual = "";

function abrirArquivo(nome, url){
  document.getElementById("modalTitulo").innerText = nome;
  document.getElementById("modalPreview").src = url;
  linkAtual = url;
  document.getElementById("modal").style.display = "flex";
}

function fecharModal(){
  document.getElementById("modal").style.display = "none";
}

function baixarArquivo(){
  window.open(linkAtual, "_blank");
}

function copiarLink(){
  navigator.clipboard.writeText(linkAtual);
  alert("Link copiado!");
}

/* =============================== */

carregar();
</script>

</body>
</html>
