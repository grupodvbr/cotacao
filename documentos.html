<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentos ‚Ä¢ Sistema de Licita√ß√µes</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>

/* =========================
   BASE GERAL ‚Äî APPLE FINDER PREMIUM
========================= */

body{
  font-family:'Inter',sans-serif;
  margin:0;
  padding:20px;
  background:#f2f2f7;
}

#container{
  backdrop-filter:blur(30px) saturate(180%);
  background:#ffffffcc;
  border-radius:18px;
  padding:25px 35px;
  max-width:1250px;
  margin:0 auto;
  border:1px solid #e3e3e5;
  box-shadow:0 8px 25px rgba(0,0,0,0.07);
}

/* =========================
   T√çTULO
========================= */
#titulo{
  text-align:center;
  font-size:26px;
  margin-bottom:25px;
  font-weight:600;
  color:#111;
}

/* =========================
   BUSCA
========================= */
#busca{
  width:100%;
  padding:12px 15px;
  margin-bottom:20px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#fafafa;
  font-size:15px;
}

/* =========================
   BREADCRUMBS
========================= */
#breadcrumbs{
  color:#555;
  font-size:15px;
  margin-bottom:20px;
  padding-left:4px;
}

/* =========================
   TOOLBAR
========================= */
.toolbar{
  display:flex;
  gap:15px;
  margin-bottom:20px;
}

.btn{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  color:white;
  font-size:14px;
}

.btn-nova{ background:#007aff; }
.btn-upload{ background:#6d28d9; }
.btn-voltar{ background:#5c5c5c; }

/* =========================
   GRID DE ITENS ‚Äî ESTILO FINDER
========================= */

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:25px;
}

.item{
  text-align:center;
  padding:25px 10px 18px;
  border-radius:16px;
  background:#ffffffd0;
  cursor:pointer;
  transition:0.25s;
  border:1px solid #e5e5e7;
  position:relative;
}

.item:hover{
  background:#ffffff;
  border-color:#007aff;
  transform:scale(1.02);
}

.item svg{
  width:60px;
  height:52px;
}

.itemNome{
  margin-top:12px;
  font-size:15px;
  font-weight:500;
  color:#333;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* MENU (‚Ä¶) ESTILO MACOS */
.menuBtn{
  position:absolute;
  top:8px;
  right:10px;
  width:28px;
  height:28px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#555;
  background:#ffffffdd;
  border:1px solid #ddd;
  cursor:pointer;
  font-size:18px;
  transition:0.2s;
}

.menuBtn:hover{
  background:#f5f5f5;
}

.menuOptions{
  position:absolute;
  top:36px;
  right:10px;
  background:white;
  border-radius:10px;
  box-shadow:0 4px 15px rgba(0,0,0,0.12);
  padding:8px 0;
  border:1px solid #ddd;
  display:none;
  z-index:999;
}

.menuOptions div{
  padding:10px 14px;
  font-size:14px;
  cursor:pointer;
  transition:0.2s;
}

.menuOptions div:hover{
  background:#f2f2f7;
}

/* =========================
   POPUP CRIAR PASTA
========================= */
#popupCriar, #popupUpload, #modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.40);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#popupBox, #uploadBox, #modalBox{
  background:white;
  padding:30px;
  width:90%;
  max-width:450px;
  border-radius:16px;
  border:1px solid #ddd;
}

/* CORES DAS PASTAS */
.colorRow{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}

.colorSelect{
  width:32px;
  height:32px;
  border-radius:50%;
  cursor:pointer;
  border:3px solid transparent;
}

.colorSelect.active{
  border-color:#000;
}

/* UPLOAD DRAG AREA */
#dropArea{
  border:2px dashed #bbb;
  padding:30px;
  text-align:center;
  border-radius:12px;
  background:#fafafa;
  margin-top:15px;
}

#dropArea.dragover{
  border-color:#007aff;
  background:#eef5ff;
}

/* MODAL PREVIEW */
#modalPreview{
  width:100%;
  height:450px;
  background:#f2f2f2;
  border:none;
  border-radius:10px;
  margin-top:15px;
}

</style>
</head>

<body>

<div id="container">

  <h1 id="titulo">GERENCIADOR DE DOCUMENTOS</h1>

  <input id="busca" placeholder="Pesquisar..." onkeyup="pesquisar()">

  <div id="breadcrumbs">üìÅ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

  <div id="lista" class="grid">Carregando...</div>

</div>


<!-- POPUP CRIAR PASTA -->
<div id="popupCriar">
  <div id="popupBox">
    <h3>Criar nova pasta</h3>

    <label>Nome:</label>
    <input id="nomePasta" style="width:100%;padding:10px;margin-top:6px;" type="text">

    <p style="margin-top:12px;">Cor:</p>
    <div class="colorRow">
      <div class="colorSelect" style="background:#4F8CF1" data-cor="azul"></div>
      <div class="colorSelect" style="background:#60D364" data-cor="verde"></div>
      <div class="colorSelect" style="background:#F8D441" data-cor="amarelo"></div>
      <div class="colorSelect" style="background:#F7A654" data-cor="laranja"></div>
      <div class="colorSelect" style="background:#F55D5D" data-cor="vermelho"></div>
      <div class="colorSelect" style="background:#BF6AF7" data-cor="roxo"></div>
      <div class="colorSelect" style="background:#A5A5A5" data-cor="cinza"></div>
      <div class="colorSelect" style="background:#000" data-cor="preto"></div>
      <div class="colorSelect" style="background:#E76BAF" data-cor="rosa"></div>
      <div class="colorSelect" style="background:#A67C52" data-cor="marrom"></div>
    </div>

    <br>
    <button onclick="criarPasta()" class="btn btn-nova" style="width:100%;">Criar</button>
    <button onclick="fecharPopupCriar()" style="margin-top:10px;border:none;background:#ddd;padding:10px;width:100%;border-radius:10px;">
      Cancelar
    </button>
  </div>
</div>


<!-- POPUP UPLOAD (drag & drop) -->
<div id="popupUpload">
  <div id="uploadBox">

    <h3>Enviar arquivo</h3>

    <label>Pasta destino:</label>
    <select id="uploadDestino" style="width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;"></select>

    <div id="dropArea">Arraste arquivos aqui ou clique para selecionar</div>

    <input id="uploadInput" type="file" multiple style="display:none">

    <button onclick="enviarUpload()" class="btn btn-upload" style="width:100%;margin-top:15px;">Enviar</button>
    <button onclick="fecharUpload()" style="margin-top:10px;border:none;background:#ddd;padding:10px;width:100%;border-radius:10px;">
      Cancelar
    </button>

  </div>
</div>


<!-- MODAL PREVIEW -->
<div id="modal">
  <div id="modalBox">
    <button class="btn btn-voltar" onclick="fecharModal()" style="float:right;">Fechar</button>
    <h2 id="modalTitulo"></h2>
    <iframe id="modalPreview"></iframe>

    <br><br>
    <button onclick="window.open(linkAtual)" class="btn btn-upload">‚¨á Download</button>
    <button onclick="navigator.clipboard.writeText(linkAtual)" class="btn btn-nova">üîó Copiar Link</button>
  </div>
</div>


<script>

/* =====================================================
   CONFIG
===================================================== */
const API = "https://script.google.com/macros/s/AKfycbxPkweyKctmiF7oQp8kKzrDFvojQtSV3K3hi8kt2-3y5ZlqBF4ewBBL_RFPTXGtoBPnxw/exec";
let usuario = localStorage.getItem("usuarioLogado") || "desconhecido";

let dados = [];
let pastaAtual = "10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp";
let historicoPastas = ["10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp"];
let corEscolhida = null;
let linkAtual = "";
let itemAbertoMenu = null;

/* =====================================================
   INICIAR
===================================================== */
carregar();

/* =====================================================
   CARREGAR LISTA
===================================================== */
async function carregar(){
  document.getElementById("lista").innerHTML = "Carregando...";

  const req = await fetch(API+"?action=listar");
  dados = await req.json();

  preencherDestinoUpload();
  mostrarPasta(pastaAtual);
}

/* =====================================================
   MOSTRAR ITENS DA PASTA
===================================================== */
function mostrarPasta(id){
  pastaAtual = id;

  const nome = dados.find(p=>p.id===id)?.nome || "Raiz";
  document.getElementById("breadcrumbs").innerText = "üìÅ " + nome;

  const itens = dados.filter(p=>p.pai===id);

  let html = "";

  itens.forEach(item => {
    
    const menuId = "menu-"+item.id;

    if(item.tipo==="pasta"){

      html += `
      <div class="item">

        <div class="menuBtn" onclick="abrirMenu(event,'${menuId}')">‚ãØ</div>
        <div class="menuOptions" id="${menuId}">
          <div onclick="acaoMover('${item.id}','${item.nome}')">üìÅ Mover</div>
          <div onclick="acaoRenomear('${item.id}','${item.nome}')">‚úèÔ∏è Renomear</div>
          <div onclick="acaoExcluir('${item.id}','${item.nome}')">üóë Excluir</div>
        </div>

        <div onclick="entrarPasta('${item.id}')">
          ${svgCor(item.capa)}
          <div class="itemNome">${item.nome}</div>
        </div>

      </div>`;
    }

    else{

      html += `
      <div class="item">

        <div class="menuBtn" onclick="abrirMenu(event,'${menuId}')">‚ãØ</div>
        <div class="menuOptions" id="${menuId}">
          <div onclick="acaoMover('${item.id}','${item.nome}')">üìÅ Mover</div>
          <div onclick="acaoRenomear('${item.id}','${item.nome}')">‚úèÔ∏è Renomear</div>
          <div onclick="acaoExcluir('${item.id}','${item.nome}')">üóë Excluir</div>
        </div>

        <div onclick="abrirArquivo('${item.nome}','${item.url}')">
          üìÑ
          <div class="itemNome">${item.nome}</div>
        </div>
        
      </div>`;
    }

  });

  document.getElementById("lista").innerHTML = html || "Nenhum item aqui.";
}


/* =====================================================
   MENU (‚Ä¶) ‚Äî ABRIR E FECHAR
===================================================== */
function abrirMenu(event, id){
  event.stopPropagation();

  if(itemAbertoMenu && itemAbertoMenu !== id){
    document.getElementById(itemAbertoMenu).style.display = "none";
  }

  const menu = document.getElementById(id);
  menu.style.display = menu.style.display === "block" ? "none" : "block";

  itemAbertoMenu = id;
}

document.onclick = function(){
  if(itemAbertoMenu){
    document.getElementById(itemAbertoMenu).style.display="none";
    itemAbertoMenu=null;
  }
};


/* =====================================================
   A√á√ïES: RENOMEAR, EXCLUIR, MOVER
===================================================== */

function acaoRenomear(id,nome){
  const novo = prompt("Novo nome:", nome);
  if(!novo) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"renomear",
      id:id,
      novoNome:novo,
      usuario:usuario
    })
  }).then(()=>carregar());
}

function acaoExcluir(id,nome){
  if(!confirm("Excluir "+nome+"?")) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"excluir",
      id:id,
      nome:nome,
      usuario:usuario
    })
  }).then(()=>carregar());
}

function acaoMover(id,nome){

  let listaPastas = dados.filter(p=>p.tipo==="pasta");

  let opcoes = "Escolha a pasta de destino:\n\n";
  listaPastas.forEach((p,i)=>{
    opcoes += `${i+1}) ${p.nome}\n`;
  });

  let escolha = prompt(opcoes);

  if(!escolha) return;

  let index = parseInt(escolha)-1;
  if(index < 0 || index >= listaPastas.length){
    return alert("Pasta inv√°lida.");
  }

  let destino = listaPastas[index].id;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"mover",
      id:id,
      novoPai:destino,
      usuario:usuario
    })
  }).then(()=>carregar());
}


/* =====================================================
   ENTER PASTA / VOLTAR
===================================================== */
function entrarPasta(id){
  historicoPastas.push(id);
  mostrarPasta(id);
}

function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas[historicoPastas.length-1]);
  }
}


/* =====================================================
   BUSCAR
===================================================== */
function pesquisar(){
  const q = document.getElementById("busca").value.toLowerCase();

  const itens = dados.filter(p =>
    p.pai===pastaAtual &&
    p.nome.toLowerCase().includes(q)
  );

  let html = "";

  itens.forEach(item=>{
    html += `
    <div class="item">
      ${item.tipo==="pasta" ? svgCor(item.capa) : "üìÑ"}
      <div class="itemNome">${item.nome}</div>
    </div>`;
  });

  document.getElementById("lista").innerHTML = html || "Nada encontrado.";
}


/* =====================================================
   POPUP CRIAR PASTA
===================================================== */
document.querySelectorAll(".colorSelect").forEach(c=>{
  c.onclick = ()=>{
    document.querySelectorAll(".colorSelect")
      .forEach(el=>el.classList.remove("active"));
    c.classList.add("active");
    corEscolhida = c.dataset.cor;
  };
});

function abrirPopupCriar(){
  document.getElementById("popupCriar").style.display="flex";
}

function fecharPopupCriar(){
  document.getElementById("popupCriar").style.display="none";
  document.getElementById("nomePasta").value="";
  corEscolhida=null;
}

function criarPasta(){
  const nome = document.getElementById("nomePasta").value.trim();
  if(!nome) return alert("Digite o nome.");
  if(!corEscolhida) return alert("Escolha a cor.");

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"criarPasta",
      nome:nome,
      cor:corEscolhida,
      usuario:usuario,
      pai:pastaAtual
    })
  }).then(()=>{
    fecharPopupCriar();
    carregar();
  });
}


/* =====================================================
   UPLOAD ‚Äî DRAG & DROP
===================================================== */
function abrirUpload(){
  document.getElementById("popupUpload").style.display="flex";
}

function fecharUpload(){
  document.getElementById("popupUpload").style.display="none";
}

function preencherDestinoUpload(){
  const select = document.getElementById("uploadDestino");
  select.innerHTML="";

  dados.filter(p=>p.tipo==="pasta")
       .forEach(p=>{
         select.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
       });
}

const drop = document.getElementById("dropArea");

drop.onclick = ()=> document.getElementById("uploadInput").click();

drop.ondragover = e=>{
  e.preventDefault();
  drop.classList.add("dragover");
};

drop.ondragleave = ()=> drop.classList.remove("dragover");

drop.ondrop = e=>{
  e.preventDefault();
  drop.classList.remove("dragover");
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){
  enviarArquivos(document.getElementById("uploadInput").files);
}

function enviarArquivos(files){
  const destino = document.getElementById("uploadDestino").value;

  [...files].forEach(file=>{
    const reader = new FileReader();

    reader.onload = ()=>{
      const base64 = reader.result.split(",")[1];

      fetch(API,{
        method:"POST",
        body:JSON.stringify({
          action:"upload",
          base64:base64,
          mime:file.type,
          nome:file.name,
          usuario:usuario,
          pai:destino
        })
      }).then(()=>carregar());
    };

    reader.readAsDataURL(file);
  });

  fecharUpload();
}


/* =====================================================
   PREVIEW
===================================================== */
function abrirArquivo(nome,url){
  document.getElementById("modalTitulo").innerText = nome;
  document.getElementById("modalPreview").src = url;
  linkAtual = url;

  document.getElementById("modal").style.display="flex";
}

function fecharModal(){
  document.getElementById("modal").style.display="none";
}

</script>

</body>
</html>
