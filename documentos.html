<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador de Documentos</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>

/* =========================
   BASE
========================= */
body{
  font-family:'Inter',sans-serif;
  margin:0;
  padding:20px;
  background:#f5f5f7;
}

#container{
  backdrop-filter:saturate(180%) blur(30px);
  background:#ffffffaa;
  border-radius:18px;
  padding:25px 35px;
  max-width:1250px;
  margin:0 auto;
  border:1px solid #e5e5e7;
}

/* =========================
   T√çTULO
========================= */
#titulo{
  text-align:center;
  font-size:26px;
  margin-bottom:25px;
  font-weight:600;
  color:#1f1f1f;
}

/* =========================
   BUSCA
========================= */
#busca{
  width:100%;
  padding:12px 15px;
  margin-bottom:20px;
  border-radius:10px;
  border:1px solid #d0d0d4;
  background:#fafafa;
  font-size:15px;
}

/* =========================
   BREADCRUMBS
========================= */
#breadcrumbs{
  color:#555;
  font-size:15px;
  margin-bottom:20px;
  padding-left:4px;
}

/* =========================
   TOOLBAR
========================= */
.toolbar{
  display:flex;
  gap:15px;
  margin-bottom:20px;
}

.btn{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  color:white;
  font-size:14px;
}

.btn-nova{ background:#007aff; }
.btn-upload{ background:#6d28d9; }
.btn-voltar{ background:#5f6368; }

/* =========================
   GRID
========================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:22px;
}

.item{
  position:relative;
  text-align:center;
  padding:18px 10px;
  border-radius:14px;
  background:#fafafa;
  cursor:pointer;
  transition:0.2s;
  border:1px solid #e5e5e7;
}

.item:hover{
  background:#ffffff;
  border-color:#007aff;
}

.itemNome{
  margin-top:10px;
  font-size:14px;
  font-weight:500;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* √≠cone de arquivo */
.arquivoIcon{
  font-size:45px;
}

/* =========================
   MENU 3 PONTOS
========================= */
.menuBtn{
  position:absolute;
  top:8px;
  right:8px;
  background:none;
  border:none;
  cursor:pointer;
  font-size:20px;
}

.menuOpc{
  display:none;
  position:absolute;
  top:32px;
  right:8px;
  background:white;
  border-radius:10px;
  border:1px solid #ddd;
  padding:8px 0;
  width:140px;
  z-index:50;
}

.menuOpc button{
  width:100%;
  padding:10px;
  background:none;
  border:none;
  text-align:left;
  font-size:14px;
  cursor:pointer;
}

.menuOpc button:hover{
  background:#f2f2f2;
}

/* =========================
   POPUPS
========================= */
.popupFundo{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

.popupBox{
  background:white;
  padding:25px;
  width:90%;
  max-width:420px;
  border-radius:14px;
  border:1px solid #ddd;
}

/* =========================
   MODAL PREVIEW
========================= */
#modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

#modalBox{
  background:white;
  padding:25px;
  width:90%;
  max-width:750px;
  border-radius:15px;
}

#modalPreview{
  width:100%;
  height:450px;
  border:none;
  border-radius:10px;
  background:#f2f2f2;
  margin-top:15px;
}

</style>
</head>

<body>

<div id="container">

  <h1 id="titulo">GERENCIADOR DE DOCUMENTOS</h1>

  <input id="busca" placeholder="Pesquisar..." onkeyup="pesquisar()">
  <div id="breadcrumbs">üìÅ Raiz</div>

  <div class="toolbar">
    <button class="btn btn-nova" onclick="abrirPopupCriar()">üìÅ Nova Pasta</button>
    <button class="btn btn-upload" onclick="abrirUpload()">‚¨Ü Upload</button>
    <button class="btn btn-voltar" onclick="voltarPasta()">‚¨Ö Voltar</button>
  </div>

  <div id="lista" class="grid">Carregando...</div>

</div>

<!-- ================= POPUPS ================ -->

<!-- CRIAR PASTA -->
<div id="popupCriar" class="popupFundo">
  <div class="popupBox">
    <h3>Criar pasta</h3>
    <input id="nomePasta" placeholder="Nome da pasta" style="width:100%;padding:10px;">
    <p>Cor:</p>
    <div id="corGrid"></div>
    <br>
    <button class="btn btn-nova" style="width:100%;" onclick="criarPasta()">Criar</button>
    <button onclick="fecharPopupCriar()" style="margin-top:10px;width:100%;padding:10px;border:none;background:#ddd;border-radius:10px;">Cancelar</button>
  </div>
</div>

<!-- UPLOAD -->
<div id="popupUpload" class="popupFundo">
  <div class="popupBox">
    <h3>Upload</h3>
    <select id="uploadDestino" style="width:100%;padding:10px;border-radius:10px;margin-bottom:10px;"></select>
    <div id="dropArea" style="border:2px dashed #bbb;padding:30px;text-align:center;border-radius:12px;">
      Arraste aqui
    </div>
    <input id="uploadInput" type="file" multiple style="display:none">
    <button class="btn btn-upload" style="width:100%;margin-top:15px;" onclick="enviarUpload()">Enviar</button>
    <button onclick="fecharUpload()" style="margin-top:10px;width:100%;padding:10px;border:none;background:#ddd;border-radius:10px;">Cancelar</button>
  </div>
</div>

<!-- RENOMEAR -->
<div id="popupRenomear" class="popupFundo">
  <div class="popupBox">
    <h3>Renomear</h3>
    <input id="novoNome" style="width:100%;padding:10px;">
    <button class="btn btn-nova" style="width:100%;margin-top:10px;" onclick="renomearItem()">Salvar</button>
    <button onclick="fecharRenomear()" style="margin-top:10px;width:100%;padding:10px;border:none;background:#ddd;border-radius:10px;">Cancelar</button>
  </div>
</div>

<!-- MOVER -->
<div id="popupMover" class="popupFundo">
  <div class="popupBox">
    <h3>Mover item</h3>
    <select id="moverDestino" style="width:100%;padding:10px;border-radius:10px;"></select>
    <button class="btn btn-nova" style="width:100%;margin-top:10px;" onclick="moverItem()">Mover</button>
    <button onclick="fecharMover()" style="margin-top:10px;width:100%;padding:10px;border:none;background:#ddd;border-radius:10px;">Cancelar</button>
  </div>
</div>

<!-- PREVIEW -->
<div id="modal">
  <div id="modalBox">
    <button class="btn btn-voltar" onclick="fecharModal()" style="float:right;">Fechar</button>
    <h2 id="modalTitulo"></h2>
    <iframe id="modalPreview"></iframe>
  </div>
</div>

<script>

/* -----------------------------
   CONFIG
----------------------------- */
const API = "https://script.google.com/macros/s/AKfycbyJ2882UNHffsf8JIAVCQLK4DyK66a5h5KJOCH1NSnmonTxj37R22WpX-mbeGxrD42NZQ/exec";
let usuario = localStorage.getItem("usuarioLogado") || "desconhecido";
let dados = [];
let pastaAtual = "10G18r0S5jDXnrOh96pQybqvfB8OH9Gxp";
let historicoPastas = [pastaAtual];
let corEscolhida = null;
let idSelecionado = null;

/* -----------------------------
   LISTAR
----------------------------- */
async function carregar(){
  document.getElementById("lista").innerHTML = "Carregando...";
  const req = await fetch(API+"?action=listar");
  dados = await req.json();
  preencherDestinoUpload();
  mostrarPasta(pastaAtual);
}

/* -----------------------------
   MOSTRAR PASTA
----------------------------- */
function mostrarPasta(id){
  pastaAtual = id;
  const nome = dados.find(p=>p.id===id)?.nome || "Raiz";
  document.getElementById("breadcrumbs").innerText = "üìÅ " + nome;

  const itens = dados.filter(p=>p.pai===id);
  let html = "";

  itens.forEach(item => {
    html += `
    <div class="item">
      <button class="menuBtn" onclick="abrirMenu(event,'${item.id}','${item.tipo}')">‚ãÆ</button>
      <div class="menuOpc" id="menu-${item.id}">
        <button onclick="abrirRenomear('${item.id}')">Renomear</button>
        <button onclick="abrirMover('${item.id}')">Mover</button>
        <button onclick="excluir('${item.id}','${item.nome}')">Excluir</button>
      </div>

      ${
        item.tipo==="pasta"
        ? svgCor(item.capa)
        : `<span class='arquivoIcon'>üìÑ</span>`
      }
      <div class="itemNome">${item.nome}</div>
      <div onclick="${ item.tipo==="pasta"
        ? `entrarPasta('${item.id}')`
        : `abrirArquivo('${item.nome}','${item.url}')`
      }" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
    </div>`;
  });

  document.getElementById("lista").innerHTML = html || "Vazio.";
}

/* -----------------------------
   MENU 3 PONTOS
----------------------------- */
function abrirMenu(ev,id){
  ev.stopPropagation();
  fecharMenus();
  document.getElementById("menu-"+id).style.display="block";
}

function fecharMenus(){
  document.querySelectorAll(".menuOpc").forEach(m => m.style.display="none");
}

document.body.onclick = () => fecharMenus();

/* -----------------------------
   RENOMEAR
----------------------------- */
function abrirRenomear(id){
  idSelecionado = id;
  const item = dados.find(x=>x.id===id);
  document.getElementById("novoNome").value = item.nome;
  document.getElementById("popupRenomear").style.display="flex";
}

function fecharRenomear(){
  document.getElementById("popupRenomear").style.display="none";
}

function renomearItem(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"renomear",
      id:idSelecionado,
      novoNome:document.getElementById("novoNome").value,
      usuario:usuario
    })
  }).then(()=>{ fecharRenomear(); carregar(); });
}

/* -----------------------------
   MOVER
----------------------------- */
function abrirMover(id){
  idSelecionado = id;
  const sel = document.getElementById("moverDestino");
  sel.innerHTML = "";

  dados.filter(p=>p.tipo==="pasta")
      .forEach(p=>{
        sel.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
      });

  document.getElementById("popupMover").style.display="flex";
}

function fecharMover(){
  document.getElementById("popupMover").style.display="none";
}

function moverItem(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"mover",
      id:idSelecionado,
      novoPai:document.getElementById("moverDestino").value,
      usuario:usuario
    })
  }).then(()=>{ fecharMover(); carregar(); });
}

/* -----------------------------
   EXCLUIR
----------------------------- */
function excluir(id,nome){
  if(!confirm("Excluir "+nome+"?")) return;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"excluir",
      id:id,
      usuario:usuario,
      nome:nome
    })
  }).then(()=>carregar());
}

/* -----------------------------
   UPLOAD
----------------------------- */
function abrirUpload(){ document.getElementById("popupUpload").style.display="flex"; }
function fecharUpload(){ document.getElementById("popupUpload").style.display="none"; }

function preencherDestinoUpload(){
  const sel = document.getElementById("uploadDestino");
  sel.innerHTML="";
  dados.filter(p=>p.tipo==="pasta")
      .forEach(p=>{
        sel.innerHTML+=`<option value="${p.id}">${p.nome}</option>`;
      });
}

const drop = document.getElementById("dropArea");
drop.onclick = ()=> document.getElementById("uploadInput").click();
drop.ondragover = e=>{ e.preventDefault(); drop.style.background="#e6f0ff"; };
drop.ondragleave = ()=> drop.style.background="";
drop.ondrop = e=>{
  e.preventDefault();
  enviarArquivos(e.dataTransfer.files);
};

function enviarUpload(){
  enviarArquivos(document.getElementById("uploadInput").files);
}

function enviarArquivos(files){

  const destino = document.getElementById("uploadDestino").value;

  [...files].forEach(file=>{
    const reader = new FileReader();

    reader.onload = ()=>{

      fetch(API,{
        method:"POST",
        body:JSON.stringify({
          action:"upload",
          base64:reader.result.split(",")[1],
          mime:file.type,
          nome:file.name,
          usuario:usuario,
          pai:destino
        })
      }).then(()=>carregar());
    };

    reader.readAsDataURL(file);
  });

  fecharUpload();
}

/* -----------------------------
   PREVIEW
----------------------------- */
function abrirArquivo(nome,url){
  document.getElementById("modalPreview").src=url;
  document.getElementById("modalTitulo").innerText=nome;
  document.getElementById("modal").style.display="flex";
}

function fecharModal(){
  document.getElementById("modal").style.display="none";
}

/* -----------------------------
   POPUP CRIAR PASTA
----------------------------- */
function abrirPopupCriar(){ document.getElementById("popupCriar").style.display="flex"; }
function fecharPopupCriar(){ document.getElementById("popupCriar").style.display="none"; }

function criarPasta(){
  const nome = document.getElementById("nomePasta").value.trim();
  if(!nome) return alert("Digite o nome.");

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"criarPasta",
      nome:nome,
      cor:"azul",
      usuario:usuario,
      pai:pastaAtual
    })
  }).then(()=>{ fecharPopupCriar(); carregar(); });
}

/* -----------------------------
   NAVEGA√á√ÉO
----------------------------- */
function entrarPasta(id){
  historicoPastas.push(id);
  mostrarPasta(id);
}

function voltarPasta(){
  if(historicoPastas.length>1){
    historicoPastas.pop();
    mostrarPasta(historicoPastas.at(-1));
  }
}

/* -----------------------------
   INICIAR
----------------------------- */
carregar();

</script>

</body>
</html>
